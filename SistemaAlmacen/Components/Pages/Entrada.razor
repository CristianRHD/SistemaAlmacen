@page "/entrada"
@rendermode InteractiveServer
@using SistemaAlmacen.Models
@using SistemaAlmacen.Services
@using Microsoft.EntityFrameworkCore
@inject IMovimientoService MovimientoService
@inject ProductoService ProductoService
@inject SistemaAlmacen.Data.ApplicationDbContext Context
@inject AuthenticationStateProvider AuthProvider
@inject IJSRuntime JS

<DialogModal @ref="DialogRef" />

<PageTitle>Entradas - AlmaTrack</PageTitle>

<div class="entrada-container">

    <div class="entrada-header">
        <h1 class="entrada-titulo">üì• Gesti√≥n de Entradas</h1>
        <button @onclick="AbrirModalNuevo" class="btn-nuevo">
            ‚ûï Nueva Entrada
        </button>
    </div>

    @if (cargando)
    {
        <div class="cargando-container">
            <p class="cargando-texto">‚è≥ Cargando entradas...</p>
        </div>
    }
    else
    {
        <div class="tabla-container">
            <div class="tabla-wrapper">
                <table class="tabla-entradas">
                    <thead class="tabla-head">
                        <tr>
                            <th class="tabla-th">Fecha</th>
                            <th class="tabla-th">Producto</th>
                            <th class="tabla-th">Proveedor</th>
                            <th class="tabla-th">Cantidad</th>
                            <th class="tabla-th">P. Compra</th>
                            <th class="tabla-th">P. Venta</th>
                            <th class="tabla-th">Total</th>
                            <th class="tabla-th">Nota</th>
                            <th class="tabla-th">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var mov in historial.Where(m => m.Tipo == "Entrada").OrderByDescending(m => m.Fecha))
                        {
                            <tr class="tabla-fila"
                                data-label-fecha="@mov.Fecha.ToString("dd/MM/yyyy")"
                                data-label-producto="@mov.Producto?.Nombre"
                                data-label-proveedor="@(mov.Proveedor?.Nombre ?? "N/A")"
                                data-label-cantidad="+@mov.Cantidad"
                                data-label-compra="RD$ @mov.PrecioCompraMov.ToString("N2")"
                                data-label-venta="RD$ @mov.PrecioVentaMov.ToString("N2")"
                                data-label-total="RD$ @((mov.PrecioCompraMov * mov.Cantidad).ToString("N2"))"
                                data-label-nota="@(string.IsNullOrEmpty(mov.Nota) ? "-" : mov.Nota)">
                                <td class="tabla-td" data-label="Fecha">
                                    <span class="fecha-badge">@mov.Fecha.ToString("dd/MM/yyyy")</span>
                                </td>
                                <td class="tabla-td" data-label="Producto">
                                    <strong>@mov.Producto?.Nombre</strong>
                                </td>
                                <td class="tabla-td" data-label="Proveedor">
                                    @(mov.Proveedor?.Nombre ?? "N/A")
                                </td>
                                <td class="tabla-td" data-label="Cantidad">
                                    <span class="cantidad-badge">+@mov.Cantidad</span>
                                </td>
                                <td class="tabla-td" data-label="P. Compra">
                                    <span class="precio-compra">RD$ @mov.PrecioCompraMov.ToString("N2")</span>
                                </td>
                                <td class="tabla-td" data-label="P. Venta">
                                    <span class="precio-venta">RD$ @mov.PrecioVentaMov.ToString("N2")</span>
                                </td>
                                <td class="tabla-td" data-label="Total">
                                    <strong>RD$ @((mov.PrecioCompraMov * mov.Cantidad).ToString("N2"))</strong>
                                </td>
                                <td class="tabla-td" data-label="Nota">
                                    <span class="nota-text">@(string.IsNullOrEmpty(mov.Nota) ? "-" : mov.Nota)</span>
                                </td>
                                <td class="tabla-td" data-label="Acciones">
                                    <div class="acciones-container">
                                        <button @onclick="() => Editar(mov)" class="btn-accion btn-editar" title="Editar">
                                            ‚úèÔ∏è
                                        </button>
                                        <button @onclick="() => Eliminar(mov)" class="btn-accion btn-eliminar" title="Eliminar">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="tabla-footer">
                <p class="tabla-total"><strong>Total:</strong> @historial.Count(m => m.Tipo == "Entrada") entradas</p>
            </div>
        </div>
    }
</div>

@if (mostrarModal)
{
    <div class="modal-overlay" @onclick="CerrarModal">
        <div class="modal-contenido" @onclick:stopPropagation>
            <div class="modal-header">
                <h3 class="modal-titulo">@(esEdicion ? "‚úèÔ∏è Editar" : "‚ûï Nueva") Entrada</h3>
                <button @onclick="CerrarModal" class="modal-cerrar">√ó</button>
            </div>

            <div class="modal-body">
                <!-- B√∫squeda de Producto con Panel de Stock -->
                <div class="form-group search-group">
                    <label class="form-label">Producto (Nombre o C√≥digo) *</label>
                    <input type="text" 
                           class="form-input" 
                           placeholder="üîç Buscar producto..." 
                           @bind="searchProducto" 
                           @oninput="OnSearchProducto" 
                           @onfocus="() => mostrarResultadosProducto = true" />
                    
                    @if (mostrarResultadosProducto && filteredProductos.Any() && productoId == 0)
                    {
                        <ul class="search-results">
                            @foreach (var p in filteredProductos)
                            {
                                <li @onclick="() => SeleccionarProducto(p)">
                                    <strong>@p.Codigo</strong> - @p.Nombre
                                    <small class="producto-categoria">@(p.Categoria?.Nombre ?? "")</small>
                                </li>
                            }
                        </ul>
                    }
                    
                    @if (productoId != 0)
                    {
                        <div class="selected-badge">
                            ‚úÖ @productoNombreSeleccionado 
                            <span class="btn-remove" @onclick="ResetProducto">‚úï</span>
                        </div>
                        
                        <!-- Panel de Stock -->
                        <div class="stock-info-panel">
                            <div class="stock-item">
                                <small>Stock Actual</small>
                                <span class="@(stockActual <= stockMinimo ? "text-danger" : "text-primary")">
                                    @stockActual
                                </span>
                            </div>
                            <div class="stock-item">
                                <small>M√≠nimo</small>
                                <span class="text-warning">@stockMinimo</span>
                            </div>
                            <div class="stock-item">
                                <small>M√°ximo</small>
                                <span class="text-success">@stockMaximo</span>
                            </div>
                        </div>
                    }
                </div>

                <!-- B√∫squeda de Proveedor -->
                <div class="form-group search-group">
                    <label class="form-label">Proveedor (Nombre o RNC) *</label>
                    <input type="text" 
                           class="form-input" 
                           placeholder="üîç Buscar proveedor..." 
                           @bind="searchProveedor" 
                           @oninput="OnSearchProveedor" 
                           @onfocus="() => mostrarResultadosProveedor = true" />
                    
                    @if (mostrarResultadosProveedor && filteredProveedores.Any() && proveedorId == 0)
                    {
                        <ul class="search-results">
                            @foreach (var prov in filteredProveedores)
                            {
                                <li @onclick="() => SeleccionarProveedor(prov)">
                                    @prov.Nombre
                                    @if (!string.IsNullOrEmpty(prov.RNC))
                                    {
                                        <small class="proveedor-rnc">RNC: @prov.RNC</small>
                                    }
                                </li>
                            }
                        </ul>
                    }
                    
                    @if (proveedorId != 0)
                    {
                        <div class="selected-badge">
                            ‚úÖ @proveedorNombreSeleccionado 
                            <span class="btn-remove" @onclick="ResetProveedor">‚úï</span>
                        </div>
                    }
                </div>

                <div class="form-grid">
                    <div>
                        <label class="form-label">Categor√≠a</label>
                        <input type="text" 
                               class="form-input form-input-readonly" 
                               value="@categoriaNombre" 
                               readonly 
                               placeholder="Auto-detectada" />
                    </div>
                    <div>
                        <label class="form-label">Fecha</label>
                        <input type="date" @bind="fecha" class="form-input" />
                    </div>
                </div>

                <div class="form-grid">
                    <div>
                        <label class="form-label">Cantidad *</label>
                        <input type="number" 
                               @bind="cantidad" 
                               min="1" 
                               class="form-input" 
                               placeholder="0" />
                    </div>
                    <div>
                        <label class="form-label">Precio de Compra</label>
                        <input type="number" 
                               @bind="precioCompra" 
                               step="0.01" 
                               class="form-input" 
                               placeholder="0.00" />
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Nota / Referencia</label>
                    <textarea @bind="nota" 
                              rows="2" 
                              class="form-textarea" 
                              placeholder="Factura, nota, etc."></textarea>
                </div>

                @if (!string.IsNullOrEmpty(error))
                {
                    <div class="error-mensaje">‚ùå @error</div>
                }

                <div class="modal-footer">
                    <button @onclick="CerrarModal" class="btn-cancelar">
                        Cancelar
                    </button>
                    <button @onclick="Guardar" disabled="@guardando" class="btn-guardar" style="opacity: @(guardando ? "0.6" : "1")">
                        @(guardando ? "‚è≥ Guardando..." : "üíæ Guardar")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .entrada-container {
        width: 100%;
        max-width: 100%;
        margin: 0;
        padding: 20px;
    }

    /* Header */
    .entrada-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 3px solid #2196f3;
    }

    .entrada-titulo {
        margin: 0;
        font-size: 2rem;
        color: #2d3748;
    }

    .btn-nuevo {
        background: linear-gradient(135deg, #2196f3, #1976d2);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
    }

    /* Estados de carga */
    .cargando-container {
        text-align: center;
        padding: 60px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .cargando-texto {
        font-size: 1.2rem;
        color: #718096;
    }

    /* Tabla */
    .tabla-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .tabla-wrapper {
        overflow-x: auto;
    }

    .tabla-entradas {
        width: 100%;
        border-collapse: collapse;
        min-width: 1000px;
    }

    .tabla-head {
        background: linear-gradient(135deg, #2196f3, #1976d2);
        color: white;
    }

    .tabla-th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
    }

    .tabla-fila {
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
    }

    .tabla-fila:hover {
        background-color: #f8f9fa;
    }

    .tabla-td {
        padding: 15px;
        color: #2d3748;
    }

    .fecha-badge {
        padding: 4px 10px;
        border-radius: 6px;
        background: #e3f2fd;
        color: #1565c0;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .cantidad-badge {
        padding: 5px 12px;
        border-radius: 20px;
        background: #4caf50;
        color: white;
        font-weight: 700;
    }

    .precio-compra {
        color: #f57c00;
        font-weight: 600;
    }

    .precio-venta {
        color: #2196f3;
        font-weight: 600;
    }

    .nota-text {
        color: #718096;
        font-size: 0.9rem;
        font-style: italic;
    }

    .acciones-container {
        display: flex;
        gap: 8px;
    }

    .btn-accion {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        color: white;
        font-size: 1.1rem;
        transition: all 0.2s;
    }

    .btn-editar {
        background: #ff9800;
    }

    .btn-eliminar {
        background: #f44336;
    }

    .tabla-footer {
        padding: 15px;
        background: white;
        text-align: right;
        border-radius: 0 0 12px 12px;
        border-top: 1px solid #f0f0f0;
    }

    .tabla-total {
        color: #2d3748;
        margin: 0;
    }

    /* Modal */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-contenido {
        background: white;
        border-radius: 15px;
        width: 90%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 25px;
        border-bottom: 2px solid #f0f0f0;
    }

    .modal-titulo {
        margin: 0;
        font-size: 1.5rem;
        color: #2d3748;
    }

    .modal-cerrar {
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        color: #718096;
        line-height: 1;
    }

    .modal-body {
        padding: 25px;
    }

    /* Formulario */
    .form-group {
        margin-bottom: 20px;
    }

    .search-group {
        position: relative;
    }

    .form-label {
        display: block;
        margin-bottom: 10px;
        font-weight: 700;
        color: #1a202c;
        font-size: 1.05rem;
    }

    .form-input, .form-select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1.05rem;
        color: #1a202c;
        font-weight: 500;
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        transition: all 0.2s ease;
    }

    .form-textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1.05rem;
        color: #1a202c;
        font-weight: 500;
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        resize: vertical;
        transition: all 0.2s ease;
    }

    .form-input-readonly {
        background: #f8f9fa;
        color: #718096;
        cursor: not-allowed;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    /* B√∫squeda desplegable */
    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid #2196f3;
        border-radius: 8px;
        z-index: 1000;
        list-style: none;
        padding: 0;
        margin: 5px 0 0 0;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .search-results li {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
    }

    .search-results li:last-child {
        border-bottom: none;
    }

    .search-results li:hover {
        background-color: #e3f2fd;
        color: #1565c0;
    }

    .producto-categoria,
    .proveedor-rnc {
        display: block;
        font-size: 0.8rem;
        color: #718096;
        margin-top: 2px;
    }

    .selected-badge {
        margin-top: 8px;
        padding: 8px 12px;
        background: #e3f2fd;
        color: #1565c0;
        border-radius: 8px;
        font-weight: 700;
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 2px solid #2196f3;
    }

    .btn-remove {
        cursor: pointer;
        color: #c62828;
        margin-left: 10px;
        font-size: 1.2rem;
        font-weight: 700;
        transition: color 0.2s;
    }

    .btn-remove:hover {
        color: #d32f2f;
    }

    /* Panel de Stock */
    .stock-info-panel {
        display: flex;
        justify-content: space-around;
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        padding: 12px;
        border-radius: 8px;
        margin-top: 10px;
        border: 2px dashed #cbd5e1;
    }

    .stock-item {
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .stock-item small {
        font-size: 0.7rem;
        color: #64748b;
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 0.5px;
    }

    .stock-item span {
        font-weight: 800;
        font-size: 1.3rem;
    }

    .text-danger {
        color: #ef4444;
    }

    .text-primary {
        color: #3b82f6;
    }

    .text-warning {
        color: #f59e0b;
    }

    .text-success {
        color: #10b981;
    }

    .error-mensaje {
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ef5350;
        font-weight: 600;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        padding-top: 20px;
        border-top: 2px solid #f0f0f0;
    }

    .btn-cancelar {
        background: #6c757d;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-guardar {
        background: #2196f3;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    /* Estados de interacci√≥n */
    input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: #2196f3 !important;
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.15) !important;
    }

    button:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .entrada-container {
            padding: 15px;
        }

        .entrada-header {
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }

        .entrada-titulo {
            font-size: 1.5rem;
            text-align: center;
        }

        .btn-nuevo {
            width: 100%;
        }

        .tabla-wrapper {
            overflow: visible;
        }

        .tabla-entradas {
            display: block;
            min-width: auto;
        }

        .tabla-head {
            display: none;
        }

        .tabla-entradas tbody {
            display: block;
        }

        .tabla-fila {
            display: block;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 15px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .tabla-td {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border: none;
        }

        .tabla-td::before {
            content: attr(data-label);
            font-weight: 700;
            color: #4b5563;
            font-size: 0.85rem;
        }

        .tabla-td:last-child {
            flex-direction: column;
            align-items: stretch;
        }

        .acciones-container {
            width: 100%;
        }

        .btn-accion {
            flex: 1;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .modal-footer {
            flex-direction: column-reverse;
        }

        .btn-cancelar,
        .btn-guardar {
            width: 100%;
        }
    }
</style>

@code {
    private List<Producto> productos = new();
    private List<Producto> filteredProductos = new();
    private List<Proveedor> proveedores = new();
    private List<Proveedor> filteredProveedores = new();
    private List<Movimiento> historial = new();
    
    private string searchProducto = "";
    private string searchProveedor = "";
    private string productoNombreSeleccionado = "";
    private string proveedorNombreSeleccionado = "";
    private bool mostrarResultadosProducto = false;
    private bool mostrarResultadosProveedor = false;
    
    private int productoId;
    private int proveedorId;
    private int cantidad = 1;
    private int editandoId = 0;
    private int stockActual;
    private int stockMinimo;
    private int stockMaximo;
    
    private string categoriaNombre = "";
    private string unidad = "";
    private string nota = "";
    private string error = "";
    private decimal precioCompra;
    private decimal precioVenta;
    private DateTime fecha = DateTime.Now;
    
    private bool cargando = true;
    private bool mostrarModal = false;
    private bool esEdicion = false;
    private bool guardando = false;
    
    private DialogModal DialogRef;

    protected override async Task OnInitializedAsync()
    {
        await Cargar();
    }

    private async Task Cargar()
    {
        cargando = true;
        productos = await ProductoService.ObtenerTodosAsync();
        proveedores = await Context.Proveedores.ToListAsync();
        historial = await MovimientoService.ObtenerTodosAsync();
        cargando = false;
    }

    private void AbrirModalNuevo()
    {
        LimpiarFormulario();
        esEdicion = false;
        mostrarModal = true;
    }

    private void OnSearchProducto(ChangeEventArgs e)
    {
        searchProducto = e.Value?.ToString() ?? "";
        mostrarResultadosProducto = true;
        
        filteredProductos = string.IsNullOrEmpty(searchProducto) 
            ? new List<Producto>() 
            : productos
                .Where(p => 
                    p.Nombre.Contains(searchProducto, StringComparison.OrdinalIgnoreCase) || 
                    p.Codigo.Contains(searchProducto, StringComparison.OrdinalIgnoreCase))
                .Take(5)
                .ToList();
    }

    private void OnSearchProveedor(ChangeEventArgs e)
    {
        searchProveedor = e.Value?.ToString() ?? "";
        mostrarResultadosProveedor = true;
        
        filteredProveedores = string.IsNullOrEmpty(searchProveedor) 
            ? new List<Proveedor>() 
            : proveedores
                .Where(p => p.Nombre.Contains(searchProveedor, StringComparison.OrdinalIgnoreCase))
                .Take(5)
                .ToList();
    }

    private void SeleccionarProducto(Producto p)
    {
        productoId = p.Id;
        productoNombreSeleccionado = $"{p.Nombre} ({p.Codigo})";
        categoriaNombre = p.Categoria?.Nombre ?? "Sin categor√≠a";
        unidad = p.Unidad ?? "Unidad";
        precioCompra = p.PrecioCompra;
        precioVenta = p.PrecioVenta;
        
        stockActual = p.Stock;
        stockMinimo = p.StockMinimo;
      
        
        searchProducto = p.Nombre;
        filteredProductos.Clear();
        mostrarResultadosProducto = false;
    }

    private void SeleccionarProveedor(Proveedor prov)
    {
        proveedorId = prov.Id;
        proveedorNombreSeleccionado = prov.Nombre;
        searchProveedor = prov.Nombre;
        filteredProveedores.Clear();
        mostrarResultadosProveedor = false;
    }

    private void ResetProducto()
    {
        productoId = 0;
        productoNombreSeleccionado = "";
        searchProducto = "";
        categoriaNombre = "";
        unidad = "";
        precioCompra = 0;
        precioVenta = 0;
        stockActual = 0;
        stockMinimo = 0;
        stockMaximo = 0;
    }

    private void ResetProveedor()
    {
        proveedorId = 0;
        proveedorNombreSeleccionado = "";
        searchProveedor = "";
    }

    private async Task Guardar()
    {
        error = "";

        if (productoId == 0 || proveedorId == 0)
        {
            error = "Debe seleccionar producto y proveedor";
            return;
        }

        if (cantidad <= 0)
        {
            error = "La cantidad debe ser mayor a 0";
            return;
        }

        guardando = true;

        try
        {
            var authState = await AuthProvider.GetAuthenticationStateAsync();
            var user = authState.User.Identity?.Name ?? "Admin";
            
            bool res = await MovimientoService.RegistrarEntradaCompletaAsync(
                productoId, cantidad, precioCompra, precioVenta, proveedorId, nota, user);
            
            if (res)
            {
                await Cargar();
                CerrarModal();
                await DialogRef.ShowSuccessAsync("Entrada registrada", "La entrada se registr√≥ correctamente");
            }
            else
            {
                error = "Error al registrar la entrada";
            }
        }
        catch (Exception ex)
        {
            error = $"Error: {ex.Message}";
        }
        finally
        {
            guardando = false;
        }
    }

    private void Editar(Movimiento mov)
    {
        editandoId = mov.Id;
        productoId = mov.ProductoId;
        proveedorId = mov.ProveedorId ?? 0;
        cantidad = mov.Cantidad;
        precioCompra = mov.PrecioCompraMov;
        precioVenta = mov.PrecioVentaMov;
        nota = mov.Nota ?? "";
        fecha = mov.Fecha;
        
        if (mov.Producto != null)
        {
            productoNombreSeleccionado = mov.Producto.Nombre;
            categoriaNombre = mov.Producto.Categoria?.Nombre ?? "";
            unidad = mov.Producto.Unidad ?? "";
            stockActual = mov.Producto.Stock;
           
        }
        
        proveedorNombreSeleccionado = mov.Proveedor?.Nombre ?? "";
        esEdicion = true;
        error = "";
        mostrarModal = true;
    }

    private async Task Eliminar(Movimiento mov)
    {
        bool ok = await DialogRef.ShowConfirmAsync(
            "Eliminar Entrada",
            $"¬øEst√° seguro de eliminar esta entrada? El stock se reducir√° en {mov.Cantidad} unidades.",
            "Eliminar",
            "üóëÔ∏è"
        );
        
        if (ok)
        {
            try
            {
                var movimiento = await Context.Movimientos
                    .Include(m => m.Producto)
                    .FirstOrDefaultAsync(m => m.Id == mov.Id);
                    
                if (movimiento != null)
                {
                    if (movimiento.Producto != null)
                    {
                        movimiento.Producto.Stock -= movimiento.Cantidad;
                    }
                    
                    Context.Movimientos.Remove(movimiento);
                    await Context.SaveChangesAsync();
                    await Cargar();
                    
                    await DialogRef.ShowSuccessAsync("Entrada eliminada", "La entrada se elimin√≥ correctamente");
                }
            }
            catch (Exception ex)
            {
                await DialogRef.ShowErrorAsync("Error", $"Error al eliminar: {ex.Message}");
            }
        }
    }

    private void CerrarModal()
    {
        mostrarModal = false;
        LimpiarFormulario();
    }

    private void LimpiarFormulario()
    {
        productoId = 0;
        proveedorId = 0;
        cantidad = 1;
        editandoId = 0;
        searchProducto = "";
        searchProveedor = "";
        productoNombreSeleccionado = "";
        proveedorNombreSeleccionado = "";
        categoriaNombre = "";
        unidad = "";
        nota = "";
        error = "";
        precioCompra = 0;
        precioVenta = 0;
        stockActual = 0;
        stockMinimo = 0;
        stockMaximo = 0;
        fecha = DateTime.Now;
        mostrarResultadosProducto = false;
        mostrarResultadosProveedor = false;
    }
}
