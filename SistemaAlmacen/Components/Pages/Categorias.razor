@page "/categorias"
@attribute [Authorize(Roles = "Admin,Gerente,Analista")]
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using SistemaAlmacen.Models
@using SistemaAlmacen.Services
@inject CategoriaService CategoriaService
@inject IJSRuntime JS

<PageTitle>Categorías - AlmaTrack</PageTitle>

<div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #ff9800;">
        <h1 style="margin: 0; font-size: 2rem;">🏷️ Gestión de Categorías</h1>
        <button @onclick="AbrirModalNueva" style="background: linear-gradient(135deg, #ff9800, #f57c00); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
            ➕ Nueva Categoría
        </button>
    </div>

    @if (cargando)
    {
        <div style="text-align: center; padding: 60px; background: white; border-radius: 12px;">
            <p style="font-size: 1.2rem;">⏳ Cargando categorías...</p>
        </div>
    }
    else if (!categorias.Any())
    {
        <div style="text-align: center; padding: 80px 20px; background: white; border-radius: 12px;">
            <div style="font-size: 5rem; margin-bottom: 20px;">🏷️</div>
            <h3 style="font-size: 1.5rem; margin-bottom: 10px;">No hay categorías registradas</h3>
            <p style="color: #666; margin-bottom: 30px;">Comienza agregando tu primera categoría</p>
            <button @onclick="AbrirModalNueva" style="background: #ff9800; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer;">
                ➕ Agregar Categoría
            </button>
        </div>
    }
    else
    {
        <input type="text" @bind="busqueda" @bind:event="oninput" placeholder="🔍 Buscar categoría..."
               style="width: 100%; padding: 12px 20px; margin-bottom: 20px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;" />

        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
            @foreach (var cat in Filtradas)
            {
                <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 5px solid #ff9800;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <h3 style="margin: 0; font-size: 1.3rem; color: #333;">@cat.Nombre</h3>
                        @if (cat.Activo)
                        {
                            <span style="padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; background: #4caf50; color: white;">✅ Activa</span>
                        }
                        else
                        {
                            <span style="padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; background: #f44336; color: white;">❌ Inactiva</span>
                        }
                    </div>

                    <p style="color: #666; margin-bottom: 15px; min-height: 40px;">
                        @(string.IsNullOrWhiteSpace(cat.Descripcion) ? "Sin descripción" : cat.Descripcion)
                    </p>

                    <div style="display: flex; gap: 8px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                        <button @onclick="() => Editar(cat)" style="flex: 1; padding: 8px; background: #2196f3; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            ✏️ Editar
                        </button>
                        <button @onclick="() => Eliminar(cat)" style="flex: 1; padding: 8px; background: #f44336; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            🗑️ Eliminar
                        </button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (mostrarModal)
{
    <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000;" @onclick="CerrarModal">
        <div style="background: white; border-radius: 15px; width: 90%; max-width: 500px;" @onclick:stopPropagation>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; border-bottom: 2px solid #f0f0f0;">
                <h3 style="margin: 0; font-size: 1.5rem;">@(esEdicion ? "✏️ Editar" : "➕ Nueva") Categoría</h3>
                <button @onclick="CerrarModal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">×</button>
            </div>

            <div style="padding: 25px;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nombre *</label>
                    <input type="text" @bind="form.Nombre" placeholder="Ej: Electrónica, Alimentos, etc."
                           style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;" />
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Descripción</label>
                    <textarea @bind="form.Descripcion" rows="4" placeholder="Descripción de la categoría..."
                              style="width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; resize: vertical;"></textarea>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" @bind="form.Activo" style="width: 20px; height: 20px;" />
                        <span style="font-weight: 600;">Categoría activa</span>
                    </label>
                </div>

                @if (!string.IsNullOrEmpty(error))
                {
                    <div style="padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; background: #ffebee; color: #c62828; border: 1px solid #ef5350;">
                        ❌ @error
                    </div>
                }

                <div style="display: flex; justify-content: flex-end; gap: 15px; padding-top: 20px; border-top: 2px solid #f0f0f0;">
                    <button type="button" @onclick="CerrarModal" style="background: #6c757d; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Cancelar
                    </button>
                    <button type="button" @onclick="Guardar" disabled="@guardando" style="background: #ff9800; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        @(guardando ? "⏳ Guardando..." : "💾 Guardar")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Categoria> categorias = new();
    private Categoria form = new();
    private string busqueda = "";
    private string error = "";
    private bool cargando = true;
    private bool mostrarModal = false;
    private bool esEdicion = false;
    private bool guardando = false;

    private List<Categoria> Filtradas =>
        string.IsNullOrWhiteSpace(busqueda)
            ? categorias
            : categorias.Where(c => c.Nombre.Contains(busqueda, StringComparison.OrdinalIgnoreCase)).ToList();

    protected override async Task OnInitializedAsync()
    {
        await Cargar();
    }

    private async Task Cargar()
    {
        cargando = true;
        categorias = await CategoriaService.ObtenerTodosAsync();
        cargando = false;
    }

    private void AbrirModalNueva()
    {
        form = new Categoria { Activo = true };
        esEdicion = false;
        error = "";
        mostrarModal = true;
    }

    private void Editar(Categoria c)
    {
        form = new Categoria
        {
            Id = c.Id,
            Nombre = c.Nombre,
            Descripcion = c.Descripcion,
            Activo = c.Activo
        };
        esEdicion = true;
        error = "";
        mostrarModal = true;
    }

    private async Task Guardar()
    {
        if (string.IsNullOrWhiteSpace(form.Nombre))
        {
            error = "El nombre es requerido";
            return;
        }

        guardando = true;
        error = "";

        try
        {
            bool ok = esEdicion
                ? await CategoriaService.ActualizarAsync(form)
                : await CategoriaService.AgregarAsync(form);

            if (ok)
            {
                await Cargar();
                CerrarModal();
                await JS.InvokeVoidAsync("alert", esEdicion ? "✅ Categoría actualizada" : "✅ Categoría agregada");
            }
            else
            {
                error = "El nombre ya existe o hubo un error";
            }
        }
        catch (Exception ex)
        {
            error = $"Error: {ex.Message}";
        }
        finally
        {
            guardando = false;
        }
    }

    private async Task Eliminar(Categoria c)
    {
        var cantidadProductos = await CategoriaService.ContarProductosAsync(c.Id);

        string mensaje = cantidadProductos > 0
            ? $"La categoría '{c.Nombre}' tiene {cantidadProductos} producto(s) asociado(s).\n\n¿Desea desactivarla?"
            : $"¿Eliminar la categoría '{c.Nombre}'?";

        bool ok = await JS.InvokeAsync<bool>("confirm", mensaje);

        if (ok)
        {
            await CategoriaService.EliminarAsync(c.Id);
            await Cargar();
            await JS.InvokeVoidAsync("alert", "✅ Categoría eliminada");
        }
    }

    private void CerrarModal()
    {
        mostrarModal = false;
        form = new();
        error = "";
    }
}