@page "/entrada"
@rendermode InteractiveServer
@using SistemaAlmacen.Models
@using SistemaAlmacen.Services
@using Microsoft.EntityFrameworkCore
@inject IMovimientoService MovimientoService
@inject ProductoService ProductoService
@inject SistemaAlmacen.Data.ApplicationDbContext Context
@inject AuthenticationStateProvider AuthProvider
@inject IJSRuntime JS

<DialogModal @ref="DialogRef" />

<PageTitle>Entradas de Almac√©n - AlmaTrack</PageTitle>

<div class="entrada-container">
    <div class="entrada-header">
        <h1 class="entrada-titulo">üì• Gesti√≥n de Entradas</h1>
        <button @onclick="AbrirModalNuevo" class="btn-nuevo">
            ‚ûï Registrar Entrada
        </button>
    </div>

    @if (cargando)
    {
        <div class="cargando-container">
            <p class="cargando-texto">‚è≥ Sincronizando registros...</p>
        </div>
    }
    else
    {
        <div class="tabla-container">
            <div class="tabla-wrapper">
                <table class="tabla-entradas">
                    <thead class="tabla-head">
                        <tr>
                            <th>Fecha</th>
                            <th>Producto / C√≥digo</th>
                            <th>Proveedor / RNC</th>
                            <th>Cant.</th>
                            <th>Costo Unit.</th>
                            <th>Responsable</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var mov in historial.Where(m => m.Tipo == "Entrada").OrderByDescending(m => m.Fecha))
                        {
                            <tr class="tabla-fila">
                                <td class="tabla-td">@mov.Fecha.ToString("dd/MM/yyyy")</td>
                                <td class="tabla-td"><strong>@mov.Producto?.Nombre</strong><br/><small>@mov.Producto?.Codigo</small></td>
                                <td class="tabla-td">@(mov.Proveedor?.Nombre ?? "N/A")<br/><small>@mov.Proveedor?.RNC</small></td>
                                <td class="tabla-td"><span class="cantidad-badge">+@mov.Cantidad</span></td>
                                <td class="tabla-td">RD$ @(mov.PrecioCompra?.ToString("N2") ?? "0.00")</td>
                                <td class="tabla-td"><span class="user-badge">üë§ @mov.UsuarioResponsable</span></td>
                                <td class="tabla-td">
                                    <button @onclick="() => Eliminar(mov)" class="btn-eliminar-simple">üóëÔ∏è</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@* MODAL DE ENTRADA CON L√ìGICA MANUAL *@
@if (mostrarModal)
{
    <div class="modal-overlay" @onclick="CerrarModal">
        <div class="modal-contenido" @onclick:stopPropagation>
            <div class="modal-header">
                <h3 class="modal-titulo">üì¶ Registro de Nueva Recepci√≥n</h3>
                <button @onclick="CerrarModal" class="modal-cerrar">√ó</button>
            </div>

            <div class="modal-body">
                @* 1. B√öSQUEDA DUAL PRODUCTO (Nombre o C√≥digo) *@
                <div class="form-group search-group">
                    <label class="form-label">Buscar Art√≠culo *</label>
                    <input type="text" class="form-input" placeholder="Escriba nombre o c√≥digo..."
                           @bind="searchProducto" @oninput="OnSearchProducto" />
                    
                    @if (mostrarResultadosProducto && filteredProductos.Any() && productoId == 0)
                    {
                        <ul class="search-results">
                            @foreach (var p in filteredProductos)
                            {
                                <li @onclick="() => SeleccionarProducto(p)">
                                    <strong>@p.Codigo</strong> - @p.Nombre (Disp: @p.Existencias)
                                </li>
                            }
                        </ul>
                    }
                    @if (productoId != 0)
                    {
                        <div class="selected-badge">‚úÖ @productoNombreSeleccionado <span class="btn-remove" @onclick="ResetProducto">‚úï</span></div>
                    }
                </div>

                @* 2. B√öSQUEDA DUAL PROVEEDOR (Nombre o RNC) *@
                <div class="form-group search-group">
                    <label class="form-label">Proveedor *</label>
                    <input type="text" class="form-input" placeholder="Escriba nombre o RNC..."
                           @bind="searchProveedor" @oninput="OnSearchProveedor" />
                    
                    @if (mostrarResultadosProveedor && filteredProveedores.Any() && proveedorId == 0)
                    {
                        <ul class="search-results">
                            @foreach (var prov in filteredProveedores)
                            {
                                <li @onclick="() => SeleccionarProveedor(prov)">
                                    <strong>@prov.Nombre</strong> (RNC: @(prov.RNC ?? "S/R"))
                                </li>
                            }
                        </ul>
                    }
                    @if (proveedorId != 0)
                    {
                        <div class="selected-badge">‚úÖ @proveedorNombreSeleccionado <span class="btn-remove" @onclick="ResetProveedor">‚úï</span></div>
                    }
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Cantidad *</label>
                        <input type="number" @bind="cantidad" min="1" class="form-input" @oninput="ValidarAlertaManual" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Costo RD$ *</label>
                        <input type="number" @bind="precioCompra" step="0.01" class="form-input" />
                    </div>
                </div>

                @* 3. CAMPO L√ìGICO MANUAL (NO SE GUARDA EN BD) *@
                <div class="form-group">
                    <label class="form-label" style="color: #1414b8;">üîî Notificarme si despu√©s de esto quedan menos de:</label>
                    <input type="number" @bind="umbralAvisoManual" class="form-input border-blue" placeholder="Ej: 5" @oninput="ValidarAlertaManual" />
                </div>

                @if (mostrarAlertaVisual)
                {
                    <div class="alert-warning-manual">
                        ‚ö†Ô∏è <strong>Atenci√≥n:</strong> Seg√∫n tu umbral (@umbralAvisoManual), este producto quedar√° en estado cr√≠tico (@(existenciasActuales + cantidad) unidades).
                    </div>
                }

                @if (!string.IsNullOrEmpty(error))
                {
                    <div class="error-mensaje">‚ùå @error</div>
                }

                <div class="modal-footer">
                    <button @onclick="CerrarModal" class="btn-cancelar">Cancelar</button>
                    <button @onclick="Guardar" disabled="@guardando" class="btn-guardar">
                        @(guardando ? "üíæ Procesando..." : "üíæ Registrar Entrada")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
   
    .entrada-container { padding: 25px; }
    .entrada-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #1414b8; padding-bottom: 15px; margin-bottom: 25px; }
    .btn-nuevo { background: #1414b8; color: white; border: none; padding: 10px 22px; border-radius: 8px; font-weight: bold; cursor: pointer; }
    
    .tabla-container { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; }
    .tabla-entradas { width: 100%; border-collapse: collapse; }
    .tabla-head { background: #f8fafc; text-align: left; }
    .tabla-head th { padding: 15px; border-bottom: 2px solid #e2e8f0; font-size: 0.85rem; color: #475569; }
    .tabla-td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; }
    

    .search-group { position: relative; }
    .search-results { position: absolute; background: white; border: 1px solid #ddd; width: 100%; z-index: 100; list-style: none; padding: 0; margin: 0; border-radius: 8px; box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
    .search-results li { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f1f5f9; }
    .search-results li:hover { background: #f1f5f9; }

    .selected-badge { background: #eef2ff; color: #1414b8; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; margin-top: 8px; font-weight: bold; border: 1px solid #c3dafe; }
    .btn-remove { color: #ef4444; cursor: pointer; padding: 0 5px; }

    
    .alert-warning-manual { background: #fff5f5; border: 1px solid #feb2b2; color: #c53030; padding: 12px; border-radius: 8px; margin-top: 10px; font-size: 0.85rem; animation: pulse 2s infinite; }
    .border-blue { border: 2px solid #1414b8 !important; }

   
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal-contenido { background: white; width: 95%; max-width: 600px; border-radius: 15px; overflow: hidden; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    .modal-header { padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 20px; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    .form-input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; }
    .modal-footer { padding: 20px; border-top: 1px solid #f1f5f9; display: flex; justify-content: flex-end; gap: 10px; }
    .btn-guardar { background: #1414b8; color: white; border: none; padding: 10px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; }

    @@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
</style>

@code {
    private List<Producto> productos = new();
    private List<Producto> filteredProductos = new();
    private List<Proveedor> proveedores = new();
    private List<Proveedor> filteredProveedores = new();
    private List<Movimiento> historial = new();
    
    private string searchProducto = "", searchProveedor = "", productoNombreSeleccionado = "", proveedorNombreSeleccionado = "", error = "";
    private bool mostrarResultadosProducto = false, mostrarResultadosProveedor = false, mostrarAlertaVisual = false;
    private int productoId, proveedorId, cantidad = 1, existenciasActuales = 0, umbralAvisoManual = 3;
    private decimal precioCompra;
    private bool cargando = true, mostrarModal = false, guardando = false;
    private DialogModal DialogRef = default!;

    protected override async Task OnInitializedAsync() => await Cargar();

    private async Task Cargar() {
        cargando = true;
        productos = await ProductoService.ObtenerTodosAsync();
        proveedores = await Context.Proveedores.ToListAsync();
        historial = await MovimientoService.ObtenerTodosAsync();
        cargando = false;
    }

    private void OnSearchProducto(ChangeEventArgs e) {
        searchProducto = e.Value?.ToString() ?? "";
        mostrarResultadosProducto = !string.IsNullOrEmpty(searchProducto);
        filteredProductos = productos.Where(p => p.Nombre.Contains(searchProducto, StringComparison.OrdinalIgnoreCase) || p.Codigo.Contains(searchProducto, StringComparison.OrdinalIgnoreCase)).Take(5).ToList();
    }

    private void OnSearchProveedor(ChangeEventArgs e) {
        searchProveedor = e.Value?.ToString() ?? "";
        mostrarResultadosProveedor = !string.IsNullOrEmpty(searchProveedor);
        filteredProveedores = proveedores.Where(p => p.Nombre.Contains(searchProveedor, StringComparison.OrdinalIgnoreCase) || (p.RNC != null && p.RNC.Contains(searchProveedor))).Take(5).ToList();
    }

    private void SeleccionarProducto(Producto p) {
        productoId = p.Id;
        productoNombreSeleccionado = $"{p.Nombre} ({p.Codigo})";
        existenciasActuales = p.Existencias;
        mostrarResultadosProducto = false;
        ValidarAlertaManual(null);
    }

    private void SeleccionarProveedor(Proveedor prov) {
        proveedorId = prov.Id;
        proveedorNombreSeleccionado = prov.Nombre;
        mostrarResultadosProveedor = false;
    }

    private void ValidarAlertaManual(ChangeEventArgs? e) {
        // L√≥gica de comparaci√≥n en memoria
        mostrarAlertaVisual = (existenciasActuales + cantidad) <= umbralAvisoManual;
    }

    private async Task Guardar() {
        if (productoId == 0 || proveedorId == 0) { error = "Complete los campos obligatorios."; return; }
        guardando = true;
        try {
            var authState = await AuthProvider.GetAuthenticationStateAsync();
            var user = authState.User.Identity?.Name ?? "Admin";
            
            bool res = await MovimientoService.RegistrarEntradaAsync(productoId, cantidad, precioCompra, proveedorId, "Entrada de Inventario", user);
            
            if (res) {
                await Cargar(); CerrarModal();
                await DialogRef.ShowSuccessAsync("√âxito", "Existencias actualizadas correctamente.");
            }
        } catch (Exception ex) { error = ex.Message; }
        finally { guardando = false; }
    }

    private async Task Eliminar(Movimiento mov) {
        if (await DialogRef.ShowConfirmAsync("Anular", "¬øRestaurar stock anterior?", "Anular", "üóëÔ∏è")) {
            var m = await Context.Movimientos.Include(x => x.Producto).FirstOrDefaultAsync(x => x.Id == mov.Id);
            if (m != null && m.Producto != null) {
                m.Producto.Existencias -= m.Cantidad;
                Context.Movimientos.Remove(m);
                await Context.SaveChangesAsync(); await Cargar();
            }
        }
    }

    private void AbrirModalNuevo() { Limpiar(); mostrarModal = true; }
    private void CerrarModal() => mostrarModal = false;
    private void ResetProducto() { productoId = 0; searchProducto = ""; existenciasActuales = 0; }
    private void ResetProveedor() { proveedorId = 0; searchProveedor = ""; }
    private void Limpiar() { productoId = 0; proveedorId = 0; cantidad = 1; precioCompra = 0; searchProducto = ""; searchProveedor = ""; error = ""; mostrarAlertaVisual = false; }
}