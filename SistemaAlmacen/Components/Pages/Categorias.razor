@page "/categorias"
@attribute [Authorize(Roles = "Admin,Gerente,Analista")]
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using SistemaAlmacen.Models
@using SistemaAlmacen.Services
@inject CategoriaService CategoriaService

<PageTitle>Categor√≠as - AlmaTrack</PageTitle>

<DialogModal @ref="DialogRef" />

<div class="categorias-container">
    <div class="categorias-header">
        <h1 class="categorias-titulo">üè∑Ô∏è Gesti√≥n de Categor√≠as</h1>
        <button @onclick="AbrirModalNueva" class="btn-nueva">
            ‚ûï Nueva Categor√≠a
        </button>
    </div>

    @if (cargando)
    {
        <div class="cargando-container">
            <p class="cargando-texto">‚è≥ Cargando categor√≠as...</p>
        </div>
    }
    else if (!categorias.Any())
    {
        <div class="vacio-container">
            <div class="vacio-icono">üè∑Ô∏è</div>
            <h3 class="vacio-titulo">No hay categor√≠as registradas</h3>
            <p class="vacio-texto">Comienza agregando tu primera categor√≠a</p>
            <button @onclick="AbrirModalNueva" class="btn-agregar">
                ‚ûï Agregar Categor√≠a
            </button>
        </div>
    }
    else
    {
        <input type="text" @bind="busqueda" @bind:event="oninput" placeholder="üîç Buscar categor√≠a..." class="input-busqueda" />

        <div class="categorias-grid">
            @foreach (var cat in Filtradas)
            {
                <div class="categoria-card">
                    <div class="card-header">
                        <h3 class="card-titulo">@cat.Nombre</h3>
                    </div>

                    <p class="card-descripcion">
                        @(string.IsNullOrWhiteSpace(cat.Descripcion) ? "Sin descripci√≥n" : cat.Descripcion)
                    </p>

                    <div class="card-acciones">
                        <button @onclick="() => Editar(cat)" class="btn-editar">
                            ‚úèÔ∏è Editar
                        </button>
                        <button @onclick="() => Eliminar(cat)" class="btn-eliminar">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (mostrarModal)
{
    <div class="modal-overlay" @onclick="CerrarModal">
        <div class="modal-contenido" @onclick:stopPropagation>
            <div class="modal-header">
                <h3 class="modal-titulo">@(esEdicion ? "‚úèÔ∏è Editar" : "‚ûï Nueva") Categor√≠a</h3>
                <button @onclick="CerrarModal" class="modal-cerrar">√ó</button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nombre *</label>
                    <input type="text" @bind="form.Nombre" placeholder="Ej: Electr√≥nica, Alimentos, etc." class="form-input" />
                </div>

                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea @bind="form.Descripcion" rows="4" placeholder="Descripci√≥n de la categor√≠a..." class="form-textarea"></textarea>
                </div>

                @if (!string.IsNullOrEmpty(error))
                {
                    <div class="error-mensaje">
                        ‚ùå @error
                    </div>
                }

                <div class="modal-footer">
                    <button type="button" @onclick="CerrarModal" class="btn-cancelar">
                        Cancelar
                    </button>
                    <button type="button" @onclick="Guardar" disabled="@guardando" class="btn-guardar">
                        @(guardando ? "‚è≥ Guardando..." : "üíæ Guardar")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .categorias-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Header */
    .categorias-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 3px solid #2196f3;
    }

    .categorias-titulo {
        margin: 0;
        font-size: 2rem;
        color: #2d3748;
    }

    .btn-nueva {
        background: linear-gradient(135deg, #2196f3, #1976d2);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .btn-nueva:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    }

    /* Estados de carga y vac√≠o */
    .cargando-container {
        text-align: center;
        padding: 60px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .cargando-texto {
        font-size: 1.2rem;
        color: #718096;
    }

    .vacio-container {
        text-align: center;
        padding: 80px 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .vacio-icono {
        font-size: 5rem;
        margin-bottom: 20px;
    }

    .vacio-titulo {
        font-size: 1.5rem;
        margin-bottom: 10px;
        color: #2d3748;
    }

    .vacio-texto {
        color: #718096;
        margin-bottom: 30px;
    }

    .btn-agregar {
        background: #2196f3;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-agregar:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    }

    /* B√∫squeda */
    .input-busqueda {
        width: 100%;
        padding: 12px 20px;
        margin-bottom: 20px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
    }

    .input-busqueda:focus {
        outline: none;
        border-color: #2196f3;
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.15);
    }

    /* Grid de categor√≠as */
    .categorias-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }

    .categoria-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-left: 5px solid #2196f3;
        transition: all 0.3s;
    }

    .categoria-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 20px rgba(33, 150, 243, 0.2);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 15px;
    }

    .card-titulo {
        margin: 0;
        font-size: 1.3rem;
        color: #1a202c;
        font-weight: 700;
    }

    .card-descripcion {
        color: #4a5568;
        margin-bottom: 15px;
        min-height: 40px;
        font-size: 0.95rem;
        line-height: 1.5;
    }

    .card-acciones {
        display: flex;
        gap: 8px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e2e8f0;
    }

    .btn-editar {
        flex: 1;
        padding: 10px;
        background: #2196f3;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-editar:hover {
        background: #1976d2;
        transform: translateY(-1px);
    }

    .btn-eliminar {
        flex: 1;
        padding: 10px;
        background: #f44336;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-eliminar:hover {
        background: #d32f2f;
        transform: translateY(-1px);
    }

    /* Modal */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-contenido {
        background: white;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 25px;
        border-bottom: 2px solid #f0f0f0;
    }

    .modal-titulo {
        margin: 0;
        font-size: 1.5rem;
        color: #2d3748;
    }

    .modal-cerrar {
        background: none;
        border: none;
        font-size: 2rem;
        cursor: pointer;
        color: #718096;
        line-height: 1;
        transition: color 0.2s;
    }

    .modal-cerrar:hover {
        color: #1a202c;
    }

    .modal-body {
        padding: 25px;
    }

    /* ============================================ */
    /* FORMULARIO MEJORADO - LETRAS M√ÅS GRANDES Y NEGRAS, SOMBRA EN INPUTS */
    /* ============================================ */
    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        margin-bottom: 10px;
        font-weight: 700;
        color: #1a202c;
        font-size: 1.05rem;
    }

    .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1.05rem;
        color: #1a202c;
        font-weight: 500;
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08), 
                    0 1px 2px rgba(0, 0, 0, 0.06);
        transition: all 0.2s ease;
    }

    .form-textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1.05rem;
        color: #1a202c;
        font-weight: 500;
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08), 
                    0 1px 2px rgba(0, 0, 0, 0.06);
        resize: vertical;
        transition: all 0.2s ease;
    }

    .form-input:focus,
    .form-textarea:focus {
        outline: none;
        border-color: #2196f3;
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.15), 
                    0 2px 4px rgba(0, 0, 0, 0.08);
    }

    .form-input::placeholder,
    .form-textarea::placeholder {
        color: #718096;
        font-weight: 400;
    }

    .error-mensaje {
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ef5350;
        font-weight: 600;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        padding-top: 20px;
        border-top: 2px solid #f0f0f0;
    }

    .btn-cancelar {
        background: #6c757d;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-cancelar:hover {
        background: #5a6268;
        transform: translateY(-1px);
    }

    .btn-guardar {
        background: #2196f3;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-guardar:hover:not(:disabled) {
        background: #1976d2;
        transform: translateY(-1px);
    }

    .btn-guardar:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .categorias-header {
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }

        .categorias-titulo {
            font-size: 1.5rem;
        }

        .categorias-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

@code {
    private List<Categoria> categorias = new();
    private Categoria form = new();
    private string busqueda = "";
    private string error = "";
    private bool cargando = true;
    private bool mostrarModal = false;
    private bool esEdicion = false;
    private bool guardando = false;
    private DialogModal DialogRef;

    private List<Categoria> Filtradas =>
        string.IsNullOrWhiteSpace(busqueda)
            ? categorias
            : categorias.Where(c => c.Nombre.Contains(busqueda, StringComparison.OrdinalIgnoreCase)).ToList();

    protected override async Task OnInitializedAsync()
    {
        await Cargar();
    }

    private async Task Cargar()
    {
        cargando = true;
        categorias = await CategoriaService.ObtenerTodosAsync();
        cargando = false;
    }

    private void AbrirModalNueva()
    {
        form = new Categoria();
        esEdicion = false;
        error = "";
        mostrarModal = true;
    }

    private void Editar(Categoria c)
    {
        form = new Categoria
        {
            Id = c.Id,
            Nombre = c.Nombre,
            Descripcion = c.Descripcion
        };
        esEdicion = true;
        error = "";
        mostrarModal = true;
    }

    private async Task Guardar()
    {
        if (string.IsNullOrWhiteSpace(form.Nombre))
        {
            error = "El nombre es requerido";
            return;
        }

        guardando = true;
        error = "";

        try
        {
            bool ok = esEdicion
                ? await CategoriaService.ActualizarAsync(form)
                : await CategoriaService.AgregarAsync(form);

            if (ok)
            {
                await Cargar();
                CerrarModal();
                await DialogRef.ShowSuccessAsync(
                    esEdicion ? "Categor√≠a actualizada" : "Categor√≠a agregada",
                    esEdicion ? "La categor√≠a se actualiz√≥ correctamente" : "La categor√≠a se agreg√≥ correctamente"
                );
            }
            else
            {
                error = "El nombre ya existe o hubo un error";
            }
        }
        catch (Exception ex)
        {
            error = $"Error: {ex.Message}";
        }
        finally
        {
            guardando = false;
        }
    }

    private async Task Eliminar(Categoria c)
    {
        bool ok = await DialogRef.ShowConfirmAsync(
            "Eliminar Categor√≠a",
            $"¬øEst√° seguro de que desea eliminar la categor√≠a '{c.Nombre}'? Esta acci√≥n no se puede deshacer.",
            "Eliminar",
            "üóëÔ∏è"
        );

        if (ok)
        {
            await CategoriaService.EliminarAsync(c.Id);
            await Cargar();
            await DialogRef.ShowSuccessAsync("Categor√≠a eliminada", "La categor√≠a se elimin√≥ correctamente");
        }
    }

    private void CerrarModal()
    {
        mostrarModal = false;
        form = new();
        error = "";
    }
}
