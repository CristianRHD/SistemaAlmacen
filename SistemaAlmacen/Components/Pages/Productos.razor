@page "/productos"
@attribute [Authorize(Roles = "Admin,Gerente,Almacenista,Analista")]
@rendermode InteractiveServer
@using SistemaAlmacen.Models
@using SistemaAlmacen.Services
@using SistemaAlmacen.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using CategoriaModel = SistemaAlmacen.Models.Categoria
@inject ProductoService ProductoService
@inject ApplicationDbContext Context

<DialogModal @ref="DialogRef" />

<PageTitle>Productos - AlmaTrack</PageTitle>

<div class="productos-container">

    <div class="productos-header">
        <h1 class="productos-titulo">📦 Gestión de Catálogo Maestro</h1>
        <button @onclick="AbrirModalNuevo" class="btn-nuevo">
            ➕ Registrar Nuevo Artículo
        </button>
    </div>

    @if (cargando)
    {
        <div class="cargando-container">
            <p class="cargando-texto">⏳ Cargando catálogo de artículos...</p>
        </div>
    }
    else if (!productos.Any())
    {
        <div class="vacio-container">
            <div class="vacio-icono">📭</div>
            <h3 class="vacio-titulo">No hay artículos en el catálogo</h3>
            <p class="vacio-texto">Define aquí los modelos de electrodomésticos y artículos del hogar.</p>
            <button @onclick="AbrirModalNuevo" class="btn-agregar">
                ➕ Agregar Primer Artículo
            </button>
        </div>
    }
    else
    {
        <input type="text" @bind="busqueda" @bind:event="oninput" placeholder="🔍 Buscar por nombre, marca o código..." class="input-busqueda" />

        <div class="tabla-container">
            <div class="tabla-wrapper">
                <table class="tabla-productos">
                    <thead class="tabla-head">
                        <tr>
                            <th class="tabla-th">Código</th>
                            <th class="tabla-th">Descripción / Modelo</th>
                            <th class="tabla-th">Categoría</th>
                            <th class="tabla-th">Existencias</th>
                            <th class="tabla-th">Fecha Registro</th>
                            <th class="tabla-th">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in Filtrados)
                        {
                            <tr class="tabla-fila">
                                <td class="tabla-td" data-label="Código">
                                    <strong class="tabla-codigo">@p.Codigo</strong>
                                </td>
                                <td class="tabla-td" data-label="Nombre">
                                    <span class="tabla-nombre">@p.Nombre</span>
                                </td>
                                <td class="tabla-td" data-label="Categoría">
                                    <span class="badge-categoria">
                                        @(p.Categoria?.Nombre ?? "Sin categoría")
                                    </span>
                                </td>
                                <td class="tabla-td" data-label="Existencias">
                                    <span class="badge-stock" style="@GetColorStock(p)">
                                        @p.Existencias unidades
                                    </span>
                                </td>
                                <td class="tabla-td" data-label="Fecha Registro">
                                    <span class="fecha-registro">@p.FechaCreacion.ToString("dd/MM/yyyy")</span>
                                </td>
                                <td class="tabla-td" data-label="Acciones">
                                    <div class="acciones-container">
                                        <button @onclick="() => Editar(p)" title="Editar" class="btn-accion btn-editar">✏️</button>
                                        <button @onclick="() => Eliminar(p)" title="Eliminar" class="btn-accion btn-eliminar">🗑️</button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="tabla-footer">
                <p class="tabla-total"><strong>Total:</strong> @Filtrados.Count modelos registrados</p>
            </div>
        </div>
    }
</div>

@* Modal Nuevo/Editar *@
@if (mostrarModal)
{
    <div class="modal-overlay" @onclick="CerrarModal">
        <div class="modal-contenido" @onclick:stopPropagation>
            <div class="modal-header">
                <h3 class="modal-titulo">@(esEdicion ? "✏️ Editar" : "➕ Nueva") Ficha de Artículo</h3>
                <button @onclick="CerrarModal" class="modal-cerrar">×</button>
            </div>

            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Código del Producto *</label>
                    <input type="text" @bind="form.Codigo" class="form-input" placeholder="Ej: TV-SAM-55-4K" />
                </div>

                <div class="form-group">
                    <label class="form-label">Nombre / Modelo *</label>
                    <input type="text" @bind="form.Nombre" class="form-input" placeholder="Ej: Smart TV Samsung 55'' QLED" />
                </div>

                <div class="form-group">
                    <label class="form-label">Descripción Técnica</label>
                    <textarea @bind="form.Descripcion" rows="3" class="form-textarea" placeholder="Especificaciones, marca, etc."></textarea>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Categoría *</label>
                        <select @bind="form.CategoriaId" class="form-select">
                            <option value="0">Seleccione...</option>
                            @foreach (var c in categorias)
                            {
                                <option value="@c.Id">@c.Nombre</option>
                            }
                        </select>
                    </div>

                    <div class="form-checkbox" style="align-self: end; padding-bottom: 12px;">
                        <label class="checkbox-label">
                            <input type="checkbox" @bind="form.Activo" class="checkbox-input" />
                            <span class="checkbox-text">Habilitar para inventario</span>
                        </label>
                    </div>
                </div>

                <div class="nota-maestra" style="background: #fff8e1; border-left: 5px solid #ffc107; padding: 15px; border-radius: 8px; font-size: 0.9rem; color: #856404; margin: 15px 0;">
                    📌 <strong>Importante:</strong> Los valores de <strong>Existencias</strong> y <strong>Costos de Compra</strong> se gestionan únicamente a través de la sección de <strong>Movimientos</strong>.
                </div>

                @if (!string.IsNullOrEmpty(error))
                {
                    <div class="error-mensaje">❌ @error</div>
                }

                <div class="modal-footer">
                    <button @onclick="CerrarModal" class="btn-cancelar">Cancelar</button>
                    <button @onclick="Guardar" disabled="@guardando" class="btn-guardar">
                        @(guardando ? "⏳..." : "💾 Guardar Ficha")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .productos-container { width: 100%; padding: 20px; }
    .productos-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #2196f3; }
    .productos-titulo { margin: 0; font-size: 2rem; color: #2d3748; }
    .btn-nuevo { background: linear-gradient(135deg, #2196f3, #1976d2); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: transform 0.2s; }

    .cargando-container, .vacio-container { text-align: center; padding: 60px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .input-busqueda { width: 100%; padding: 12px 20px; margin-bottom: 20px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; }

    .tabla-container { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .tabla-wrapper { overflow-x: auto; }
    .tabla-productos { width: 100%; border-collapse: collapse; min-width: 900px; }
    .tabla-head { background: linear-gradient(135deg, #2196f3, #1976d2); color: white; }
    .tabla-th { padding: 15px; text-align: left; font-weight: 600; }
    .tabla-fila { border-bottom: 1px solid #f0f0f0; transition: background-color 0.2s; }
    .tabla-fila:hover { background-color: #f8f9fa; }
    .tabla-td { padding: 15px; }

    .badge-categoria { padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }
    .badge-stock { padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }

    .fecha-registro { font-size: 0.85rem; color: #64748b; font-weight: 500; }

    .acciones-container { display: flex; gap: 8px; }
    .btn-accion { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; color: white; font-size: 1.1rem; transition: all 0.2s; }
    .btn-ver { background: #2196f3; }
    .btn-editar { background: #ff9800; }
    .btn-eliminar { background: #f44336; }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal-contenido { background: white; border-radius: 15px; width: 90%; max-width: 650px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; border-bottom: 2px solid #f0f0f0; }
    .modal-body { padding: 25px; }

    .form-group { margin-bottom: 20px; }
    .form-label { display: block; margin-bottom: 8px; font-weight: 700; color: #1a202c; font-size: 0.95rem; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; transition: border-color 0.2s; }
    .form-input:focus { outline: none; border-color: #2196f3; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

    .checkbox-label { display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .checkbox-input { width: 18px; height: 18px; }
    .checkbox-text { font-weight: 600; color: #4a5568; }

    .modal-footer { display: flex; justify-content: flex-end; gap: 15px; padding: 20px 25px; border-top: 2px solid #f0f0f0; }
    .btn-cancelar { background: #edf2f7; color: #4a5568; padding: 10px 20px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; }
    .btn-guardar { background: #2196f3; color: white; padding: 10px 25px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; }

    .tabla-footer { padding: 15px 20px; border-top: 1px solid #f0f0f0; }
    .tabla-total { margin: 0; font-size: 0.9rem; color: #4a5568; }
</style>

@code {
    private List<Producto> productos = new();
    private List<CategoriaModel> categorias = new();
    private Producto form = new();
    private Producto? detalle;
    private string busqueda = "";
    private string error = "";
    private bool cargando = true;
    private bool mostrarModal = false;
    private bool mostrarDetalle = false;
    private bool esEdicion = false;
    private bool guardando = false;
    private DialogModal DialogRef;

    private List<Producto> Filtrados =>
        string.IsNullOrWhiteSpace(busqueda)
            ? productos
            : productos.Where(p =>
                p.Nombre.Contains(busqueda, StringComparison.OrdinalIgnoreCase) ||
                p.Codigo.Contains(busqueda, StringComparison.OrdinalIgnoreCase)
            ).ToList();

    protected override async Task OnInitializedAsync() => await Cargar();

    private async Task Cargar()
    {
        cargando = true;
        productos = await ProductoService.ObtenerTodosAsync();
        categorias = await ProductoService.ObtenerCategoriasAsync();
        cargando = false;
    }

    private void AbrirModalNuevo()
    {
        form = new Producto { Activo = true, FechaCreacion = DateTime.Now };
        esEdicion = false;
        error = "";
        mostrarModal = true;
    }

    private void Editar(Producto p)
    {
        form = new Producto
        {
            Id            = p.Id,
            Codigo        = p.Codigo,
            Nombre        = p.Nombre,
            Descripcion   = p.Descripcion,
            CategoriaId   = p.CategoriaId,
            Activo        = p.Activo,
            FechaCreacion = p.FechaCreacion
        };
        esEdicion = true;
        error = "";
        mostrarModal = true;
    }

    private async Task Guardar()
    {
        if (string.IsNullOrWhiteSpace(form.Codigo) || string.IsNullOrWhiteSpace(form.Nombre))
        {
            error = "Código y Nombre son requeridos";
            return;
        }

        if (form.CategoriaId == 0)
        {
            error = "Seleccione una categoría";
            return;
        }

        guardando = true;
        error = "";

        try
        {
            bool ok = esEdicion
                ? await ProductoService.ActualizarAsync(form)
                : await ProductoService.AgregarAsync(form);

            if (ok)
            {
                await Cargar();
                CerrarModal();
                await DialogRef.ShowSuccessAsync("Éxito", esEdicion ? "Ficha actualizada" : "Nuevo modelo registrado");
            }
            else { error = "El código ya existe"; }
        }
        catch (Exception ex) { error = ex.Message; }
        finally { guardando = false; }
    }

    private async Task Eliminar(Producto p)
    {
        if (p.Existencias > 0)
        {
            await DialogRef.ShowErrorAsync("Alerta", "No se puede eliminar un artículo que aún tiene existencias físicas en el almacén.");
            return;
        }

        bool ok = await DialogRef.ShowConfirmAsync("Eliminar", $"¿Desea borrar '{p.Nombre}' del catálogo?", "Eliminar", "🗑️");
        if (ok)
        {
            await ProductoService.EliminarAsync(p.Id);
            await Cargar();
            await DialogRef.ShowSuccessAsync("Eliminado", "El artículo ha sido removido del catálogo maestro.");
        }
    }

    private void VerDetalle(Producto p) { detalle = p; mostrarDetalle = true; }
    private void CerrarModal() { mostrarModal = false; form = new(); error = ""; }
    private void CerrarDetalle() { mostrarDetalle = false; detalle = null; }

    private string GetColorStock(Producto p)
    {
        if (p.Existencias == 0) return "background: #fee2e2; color: #b91c1c; border: 1px solid #f87171;";
        return "background: #dcfce7; color: #15803d; border: 1px solid #4ade80;";
    }
}
