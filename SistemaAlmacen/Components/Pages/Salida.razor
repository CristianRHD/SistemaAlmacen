@page "/salida"
@attribute [Authorize(Roles = "Admin,Gerente,Almacenista")]
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using SistemaAlmacen.Models
@using SistemaAlmacen.Services
@using SistemaAlmacen.Data
@using Microsoft.EntityFrameworkCore
@inject ProductoService ProductoService
@inject IMovimientoService MovimientoService
@inject ApplicationDbContext Context
@inject AuthenticationStateProvider AuthProvider
@inject IJSRuntime JS
@inject SistemaAlmacen.Data.ApplicationDbContext ContextConf

<DialogModal @ref="DialogRef" />

<PageTitle>Despachos - AlmaTrack</PageTitle>

<div class="main-content-wrapper">
    <div class="salida-header-top">
        <div>
            <h1 class="salida-titulo">Gesti√≥n de Despachos</h1>
            <p class="salida-subtitulo">Registro y control de salidas del almac√©n central</p>
        </div>
        <button @onclick="AbrirModalNuevo" class="btn-nuevo">
            <span class="btn-icon">Ôºã</span> Nuevo Despacho
        </button>
    </div>

    <div class="tabla-container">
        <table class="tabla-almatrack">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Referencia</th>
                    <th>Destino</th>
                    <th>Art√≠culos</th>
                    <th>Responsable</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var grupo in historialSalidas
                    .GroupBy(m => m.Observaciones)
                    .OrderByDescending(g => g.Max(m => m.Id)))
                {
                    <tr>
                        <td class="col-fecha">@grupo.First().Fecha.ToString("dd/MM/yyyy")</td>
                        <td><span class="ref-tag">@grupo.Key</span></td>
                        <td>@grupo.First().Destino</td>
                        <td><span class="badge-count">@grupo.Count() √≠tems</span></td>
                        <td class="col-usuario">@grupo.First().UsuarioResponsable</td>
                        <td>
                            <button class="btn-accion" title="Imprimir Conduce"
                                    @onclick="() => Reimprimir(grupo.Key ?? string.Empty)">
                                üñ®Ô∏è Imprimir
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@if (mostrarModal)
{
    <div class="modal-overlay" @onclick="CerrarModal">
        <div class="modal-card" @onclick:stopPropagation="true">

            <div class="modal-header">
                <div>
                    <h3 class="modal-title">Nuevo Despacho Interno</h3>
                    <p class="modal-ref">Ref: <strong>@proximaReferencia</strong></p>
                </div>
                <button @onclick="CerrarModal" class="btn-close-modal">√ó</button>
            </div>

            <div class="modal-body">

                <!-- Fila destino + observaciones -->
                <div class="form-row-2">
                    <div class="form-group">
                        <label class="form-label">Destino / √Årea <span class="req">*</span></label>
                        <input type="text" @bind="destino" class="form-input" placeholder="Ej: Sucursal Cotu√≠" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Observaciones</label>
                        <input type="text" @bind="notasLibres" class="form-input" placeholder="Ej: Urgente, para evento..." />
                    </div>
                </div>

                <!-- Layout de dos columnas: b√∫squeda izquierda, lista derecha -->
                <div class="despacho-grid">

                    <!-- COLUMNA IZQUIERDA: buscar y seleccionar -->
                    <div class="col-busqueda">
                        <div class="form-group search-group">
                            <label class="form-label">üîç Buscar producto</label>
                            <div class="search-wrap">
                                <input type="text" value="@searchQuery" @oninput="OnSearchProducto"
                                       class="form-input search-input" placeholder="Nombre o c√≥digo..." />
                                @if (mostrarSugerencias && filteredProductos.Any())
                                {
                                    <ul class="suggestions">
                                        @foreach (var p in filteredProductos)
                                        {
                                            <li @onclick="() => SeleccionarProducto(p)">
                                                <div class="sug-top">
                                                    <span class="sug-code">@p.Codigo</span>
                                                    <span class="sug-stock">@p.Existencias en stock</span>
                                                </div>
                                                <span class="sug-name">@p.Nombre</span>
                                            </li>
                                        }
                                    </ul>
                                }
                            </div>
                        </div>

                        @if (productoSeleccionado != null)
                        {
                            <div class="add-bar">
                                <div class="selected-info">
                                    <span class="sel-code">@productoSeleccionado.Codigo</span>
                                    <span class="sel-name">@productoSeleccionado.Nombre</span>
                                    <span class="sel-stock">üì¶ @productoSeleccionado.Existencias disponibles</span>
                                </div>
                                <div class="add-controls">
                                    <label class="form-label" style="margin:0">Lotes:</label>
                                    <input type="number" @bind="cantidadADespachar" @bind:event="oninput"
                                           class="input-cantidad" min="1" max="@productoSeleccionado.Existencias" />
                                    <button @onclick="AgregarALista" class="btn-add-item">‚ûï A√±adir</button>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="empty-hint">
                                <span>üëÜ Busca un producto para agregarlo al despacho</span>
                            </div>
                        }
                    </div>

                    <!-- COLUMNA DERECHA: lista de art√≠culos -->
                    <div class="col-lista">
                        <div class="lista-header">
                            <span class="lista-titulo">üìã Art√≠culos a despachar</span>
                            @if (listaSalida.Any())
                            {
                                <span class="preview-total">@listaSalida.Count productos ¬∑ @listaSalida.Sum(x => x.Cantidad) lotes</span>
                            }
                        </div>

                        @if (listaSalida.Any())
                        {
                            <div class="lista-scroll">
                                <table class="mini-table">
                                    <thead>
                                        <tr>
                                            <th>C√≥digo</th>
                                            <th>Producto</th>
                                            <th style="text-align:center">Lotes</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in listaSalida)
                                        {
                                            <tr>
                                                <td><span class="item-code">@item.ProductoCodigo</span></td>
                                                <td class="item-name">@item.ProductoNombre</td>
                                                <td style="text-align:center"><span class="item-qty">@item.Cantidad</span></td>
                                                <td><button class="btn-remove" @onclick="() => QuitarDeLista(item)" title="Quitar">‚úï</button></td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="lista-vacia">
                                <span>üì≠</span>
                                <p>No hay art√≠culos agregados a√∫n</p>
                            </div>
                        }
                    </div>

                </div>
            </div>

            <div class="modal-footer">
                <div class="footer-info">
                    @if (listaSalida.Any())
                    {
                        <span class="footer-count">‚úÖ @listaSalida.Count producto(s) ¬∑ @listaSalida.Sum(x => x.Cantidad) lote(s) total</span>
                    }
                </div>
                <div class="footer-btns">
                    <button @onclick="CerrarModal" class="btn-cancel">Cancelar</button>
                    <button @onclick="ProcesarSalida"
                            disabled="@(!listaSalida.Any() || string.IsNullOrEmpty(destino) || guardando)"
                            class="btn-save">
                        @(guardando ? "‚è≥ Procesando..." : "üñ®Ô∏è Procesar y Generar Conduce")
                    </button>
                </div>
            </div>

        </div>
    </div>
}

<style>
    @@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Sora:wght@400;500;600;700&display=swap');

    :root {
        --blue: #1414b8; --blue-light: #eef2ff; --blue-mid: #4f52d3;
        --text: #1e293b; --muted: #64748b; --border: #e2e8f0;
        --bg: #f8fafc; --white: #ffffff; --danger: #ef4444; --success: #10b981;
        --mono: 'IBM Plex Mono', monospace; --sans: 'Sora', sans-serif;
        --radius: 10px; --shadow: 0 4px 24px rgba(20,20,184,0.07);
    }

    .main-content-wrapper { padding: 32px; font-family: var(--sans); }

    .salida-header-top {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 28px; padding-bottom: 20px; border-bottom: 2px solid var(--border);
    }
    .salida-titulo { font-size: 1.6rem; font-weight: 700; color: var(--text); margin: 0; }
    .salida-subtitulo { color: var(--muted); font-size: 0.875rem; margin: 4px 0 0; }

    .btn-nuevo {
        display: flex; align-items: center; gap: 8px;
        background: var(--blue); color: white; border: none;
        padding: 11px 22px; border-radius: var(--radius);
        font-weight: 600; font-size: 0.9rem; cursor: pointer;
        font-family: var(--sans); transition: background 0.2s, transform 0.1s;
    }
    .btn-nuevo:hover { background: var(--blue-mid); transform: translateY(-1px); }

    .tabla-container {
        background: var(--white); border-radius: 14px;
        border: 1px solid var(--border); overflow: hidden; box-shadow: var(--shadow);
    }
    .tabla-almatrack { width: 100%; border-collapse: collapse; font-family: var(--sans); }
    .tabla-almatrack thead tr { background: var(--bg); border-bottom: 2px solid var(--border); }
    .tabla-almatrack th { padding: 14px 18px; text-align: left; font-size: 0.78rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); }
    .tabla-almatrack td { padding: 14px 18px; border-bottom: 1px solid var(--border); font-size: 0.9rem; color: var(--text); }
    .tabla-almatrack tbody tr:last-child td { border-bottom: none; }
    .tabla-almatrack tbody tr:hover { background: #fafbff; }

    .ref-tag { font-family: var(--mono); font-size: 0.8rem; background: var(--blue-light); color: var(--blue); padding: 3px 9px; border-radius: 5px; font-weight: 600; }
    .badge-count { background: #f0fdf4; color: var(--success); border: 1px solid #bbf7d0; padding: 3px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
    .col-fecha { font-family: var(--mono); font-size: 0.82rem; color: var(--muted); }
    .col-usuario { font-size: 0.85rem; color: var(--muted); }
    .btn-accion { font-size: 0.8rem; background: var(--blue-light); color: var(--blue); border: 1px solid #c7d2fe; padding: 6px 14px; border-radius: 7px; cursor: pointer; font-weight: 600; font-family: var(--sans); transition: background 0.15s; }
    .btn-accion:hover { background: #e0e7ff; }

    /* ‚îÄ‚îÄ MODAL GRANDE ‚îÄ‚îÄ */
    .modal-overlay {
        position: fixed; inset: 0; background: rgba(15,23,42,0.6);
        display: flex; align-items: center; justify-content: center;
        z-index: 1000; padding: 16px; backdrop-filter: blur(4px);
    }

    .modal-card {
        background: var(--white); width: 100%; max-width: 1100px;
        border-radius: 18px; overflow: hidden;
        box-shadow: 0 30px 80px rgba(0,0,0,0.22);
        font-family: var(--sans); height: 92vh;
        display: flex; flex-direction: column;
    }

    .modal-header {
        display: flex; justify-content: space-between; align-items: flex-start;
        padding: 20px 28px 16px; border-bottom: 1px solid var(--border); background: var(--bg);
        flex-shrink: 0;
    }
    .modal-title { margin: 0; font-size: 1.2rem; font-weight: 700; color: var(--text); }
    .modal-ref { margin: 4px 0 0; font-size: 0.8rem; color: var(--muted); font-family: var(--mono); }
    .btn-close-modal { background: none; border: 1px solid var(--border); width: 34px; height: 34px; border-radius: 8px; font-size: 1.3rem; cursor: pointer; color: var(--muted); line-height: 1; transition: background 0.15s; flex-shrink: 0; }
    .btn-close-modal:hover { background: var(--border); color: var(--text); }

    .modal-body { padding: 20px 28px 12px; overflow: hidden; flex: 1; display: flex; flex-direction: column; }

    .form-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; flex-shrink: 0; }
    @@media (max-width: 600px) { .form-row-2 { grid-template-columns: 1fr; } }

    .form-group { margin-bottom: 0; position: relative; }
    .form-label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 7px; }
    .req { color: var(--danger); }
    .form-input { width: 100%; padding: 10px 14px; border: 1.5px solid var(--border); border-radius: var(--radius); font-size: 0.9rem; color: var(--text); font-family: var(--sans); background: var(--white); transition: border-color 0.2s, box-shadow 0.2s; box-sizing: border-box; }
    .form-input:focus { outline: none; border-color: var(--blue); box-shadow: 0 0 0 3px rgba(20,20,184,0.1); }

    /* ‚îÄ‚îÄ GRID DOS COLUMNAS ‚îÄ‚îÄ */
    .despacho-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
        flex: 1; overflow: hidden; min-height: 0;
    }
    @@media (max-width: 750px) { .despacho-grid { grid-template-columns: 1fr; } }

    /* ‚îÄ‚îÄ COLUMNA B√öSQUEDA ‚îÄ‚îÄ */
    .col-busqueda { display: flex; flex-direction: column; gap: 12px; overflow: visible; }

    .search-wrap { position: relative; }
    .search-input { padding-left: 14px; font-size: 0.95rem; }

    .suggestions {
        position: absolute; top: calc(100% + 4px); left: 0; right: 0;
        background: var(--white); border: 1.5px solid var(--border);
        border-radius: var(--radius); list-style: none; padding: 6px 0; margin: 0;
        z-index: 300; box-shadow: 0 12px 32px rgba(0,0,0,0.14);
        max-height: 280px; overflow-y: auto;
    }
    .suggestions li {
        display: flex; flex-direction: column; gap: 2px;
        padding: 10px 14px; cursor: pointer; transition: background 0.1s;
        border-bottom: 1px solid var(--border);
    }
    .suggestions li:last-child { border-bottom: none; }
    .suggestions li:hover { background: var(--blue-light); }
    .sug-top { display: flex; justify-content: space-between; align-items: center; }
    .sug-code { font-family: var(--mono); font-size: 0.78rem; color: var(--blue); font-weight: 700; }
    .sug-name { font-size: 0.88rem; color: var(--text); font-weight: 500; }
    .sug-stock { font-size: 0.75rem; color: var(--muted); background: var(--bg); padding: 2px 8px; border-radius: 4px; }

    .add-bar {
        background: var(--blue-light); border: 1.5px solid #c7d2fe;
        border-radius: var(--radius); padding: 14px 16px;
    }
    .selected-info { display: flex; flex-direction: column; gap: 3px; margin-bottom: 12px; }
    .sel-code { font-family: var(--mono); font-size: 0.78rem; color: var(--blue); font-weight: 700; }
    .sel-name { font-weight: 700; font-size: 1rem; color: var(--text); }
    .sel-stock { font-size: 0.8rem; color: var(--muted); }

    .add-controls { display: flex; align-items: center; gap: 10px; }
    .input-cantidad { width: 80px; padding: 9px 12px; border: 1.5px solid #c7d2fe; border-radius: 8px; font-size: 0.95rem; font-family: var(--mono); background: var(--white); text-align: center; }
    .btn-add-item { background: var(--blue); color: white; border: none; padding: 9px 20px; border-radius: 8px; font-weight: 600; font-size: 0.88rem; cursor: pointer; font-family: var(--sans); transition: background 0.15s; flex: 1; }
    .btn-add-item:hover { background: var(--blue-mid); }

    .empty-hint {
        flex: 1; display: flex; align-items: center; justify-content: center;
        border: 2px dashed var(--border); border-radius: var(--radius);
        color: var(--muted); font-size: 0.85rem; text-align: center; padding: 30px 20px;
        min-height: 120px;
    }

    /* ‚îÄ‚îÄ COLUMNA LISTA ‚îÄ‚îÄ */
    .col-lista {
        display: flex; flex-direction: column;
        border: 1.5px solid var(--border); border-radius: var(--radius); overflow: hidden;
    }

    .lista-header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 12px 16px; background: var(--bg); border-bottom: 1px solid var(--border);
        flex-shrink: 0;
    }
    .lista-titulo { font-size: 0.82rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
    .preview-total { background: var(--blue-light); color: var(--blue); padding: 3px 10px; border-radius: 4px; font-weight: 700; font-size: 0.78rem; }

    .lista-scroll { flex: 1; overflow-y: auto; }

    .mini-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    .mini-table th { padding: 9px 12px; background: var(--bg); border-bottom: 1px solid var(--border); font-size: 0.72rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.04em; text-align: left; position: sticky; top: 0; }
    .mini-table td { padding: 10px 12px; border-bottom: 1px solid var(--border); color: var(--text); }
    .mini-table tbody tr:last-child td { border-bottom: none; }
    .mini-table tbody tr:hover { background: #fafbff; }

    .item-code { font-family: var(--mono); font-size: 0.75rem; color: var(--blue); font-weight: 600; }
    .item-name { font-size: 0.88rem; }
    .item-qty { background: var(--blue-light); color: var(--blue); padding: 2px 10px; border-radius: 4px; font-weight: 700; font-family: var(--mono); font-size: 0.85rem; }

    .btn-remove { background: none; border: none; color: var(--danger); cursor: pointer; font-size: 0.9rem; padding: 4px 8px; border-radius: 5px; transition: background 0.1s; }
    .btn-remove:hover { background: #fee2e2; }

    .lista-vacia { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--muted); gap: 8px; padding: 40px 20px; }
    .lista-vacia span { font-size: 2rem; }
    .lista-vacia p { font-size: 0.85rem; margin: 0; }

    /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
    .modal-footer {
        padding: 14px 28px; border-top: 1px solid var(--border);
        display: flex; justify-content: space-between; align-items: center;
        background: var(--bg); flex-shrink: 0;
    }
    .footer-info { font-size: 0.85rem; color: var(--muted); }
    .footer-count { font-weight: 600; color: var(--success); }
    .footer-btns { display: flex; gap: 10px; }

    .btn-cancel { background: var(--white); color: var(--muted); border: 1.5px solid var(--border); padding: 10px 20px; border-radius: var(--radius); font-weight: 600; cursor: pointer; font-family: var(--sans); font-size: 0.9rem; }
    .btn-cancel:hover { border-color: var(--muted); color: var(--text); }
    .btn-save { background: var(--blue); color: white; border: none; padding: 10px 24px; border-radius: var(--radius); font-weight: 600; cursor: pointer; font-family: var(--sans); font-size: 0.9rem; transition: background 0.15s, opacity 0.15s; }
    .btn-save:hover { background: var(--blue-mid); }
    .btn-save:disabled { opacity: 0.5; cursor: not-allowed; }
</style>

<script>
    window.printConduce = function (data) {
        var fmt = function(n) {
            return 'RD$ ' + Number(n).toLocaleString('es-DO', {minimumFractionDigits:2, maximumFractionDigits:2});
        };
        var rows = data.items.map(function(i) {
            return '<tr>'
                + '<td>' + i.codigo + '</td>'
                + '<td>' + i.nombre + '</td>'
                + '<td style="text-align:center">' + i.cantidad + '</td>'
                + '<td style="text-align:right">' + fmt(i.totalItem) + '</td>'
                + '</tr>';
        }).join('');
        var totalUnidades = data.items.reduce(function(s, i) { return s + i.cantidad; }, 0);
        var totalValor    = data.items.reduce(function(s, i) { return s + i.totalItem; }, 0);

        var logoHtml = data.empresaLogo
            ? '<img src="' + data.empresaLogo + '" style="height:52px;max-width:90px;object-fit:contain;border-radius:8px;" />'
            : '<div class="logo">' + data.empresaIniciales + '</div>';

        var html = '<!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"/><title>Conduce ' + data.referencia + '</title>'
            + '<style>'
            + '* { margin:0; padding:0; box-sizing:border-box; }'
            + 'body { font-family: Arial, sans-serif; background:white; color:#000; padding: 1.8cm 2cm; }'
            + '.header { display:flex; justify-content:space-between; align-items:flex-start; border-bottom:3px solid #1414b8; padding-bottom:16px; margin-bottom:20px; }'
            + '.brand { display:flex; align-items:center; gap:12px; }'
            + '.logo { width:52px; height:52px; background:#1414b8; color:white; font-size:17pt; font-weight:900; display:flex; align-items:center; justify-content:center; border-radius:9px; print-color-adjust:exact; -webkit-print-color-adjust:exact; }'
            + '.brand-name { font-size:22pt; font-weight:900; color:#1414b8; }'
            + '.brand-sub { font-size:7.5pt; color:#555; text-transform:uppercase; letter-spacing:.1em; margin-top:3px; }'
            + '.ref-box { text-align:right; }'
            + '.ref-label { font-size:8pt; text-transform:uppercase; letter-spacing:.1em; color:#555; font-weight:700; }'
            + '.ref-num { font-size:14pt; font-weight:900; color:#1414b8; font-family:Courier New,monospace; margin:3px 0; }'
            + '.ref-date { font-size:9pt; color:#333; }'
            + '.info-grid { display:flex; border:1px solid #ccc; margin-bottom:20px; }'
            + '.info-item { flex:1; padding:9px 13px; border-right:1px solid #ccc; }'
            + '.info-item:last-child { border-right:none; }'
            + '.info-label { display:block; font-size:7pt; font-weight:700; text-transform:uppercase; letter-spacing:.08em; color:#666; margin-bottom:3px; }'
            + '.info-value { font-size:10pt; font-weight:700; color:#000; }'
            + 'table { width:100%; border-collapse:collapse; table-layout:fixed; }'
            + 'thead tr { background:#1414b8; print-color-adjust:exact; -webkit-print-color-adjust:exact; }'
            + 'thead th { color:white; padding:8px 11px; font-size:8.5pt; font-weight:700; text-align:left; text-transform:uppercase; letter-spacing:.06em; }'
            + 'tbody td { padding:8px 11px; border-bottom:1px solid #e0e0e0; font-size:10pt; word-wrap:break-word; }'
            + 'tbody tr:nth-child(even) td { background:#f5f5f5; print-color-adjust:exact; -webkit-print-color-adjust:exact; }'
            + '.total-row td { border-top:2px solid #1414b8; border-bottom:none; font-weight:700; padding:10px 11px; font-size:10pt; }'
            + '.obs { margin-top:16px; padding:9px 13px; border:1px solid #ddd; font-size:9.5pt; color:#333; }'
            + '.firmas { display:flex; justify-content:space-around; margin-top:80px; }'
            + '.firma { width:36%; text-align:center; }'
            + '.linea { border-top:1.5px solid #000; margin-bottom:7px; }'
            + '.firma p { font-size:8pt; font-weight:700; text-transform:uppercase; letter-spacing:.08em; }'
            + '@@media print { @@page { size:letter portrait; margin:1.5cm 2cm; } body { padding:0; } }'
            + '</style></head><body>'
            + '<div class="header">'
            +   '<div class="brand">' + logoHtml + '<div><div class="brand-name">' + data.empresaNombre + '</div><div class="brand-sub">' + data.empresaSlogan + '</div></div></div>'
            +   '<div class="ref-box"><div class="ref-label">Conduce de Salida</div><div class="ref-num">' + data.referencia + '</div><div class="ref-date">' + data.fecha + '</div></div>'
            + '</div>'
            + '<div class="info-grid">'
            +   '<div class="info-item"><span class="info-label">Origen</span><span class="info-value">' + (data.empresaNombre ? data.empresaNombre.toUpperCase() : 'ALMAC\u00C9N CENTRAL') + '</span></div>'
            +   '<div class="info-item"><span class="info-label">Destino</span><span class="info-value">' + (data.destino || 'NO ESPECIFICADO') + '</span></div>'
            +   '<div class="info-item"><span class="info-label">Responsable</span><span class="info-value">' + data.usuario + '</span></div>'
            + '</div>'
            + '<table>'
            +   '<thead><tr>'
            +     '<th style="width:14%">C\u00F3digo</th>'
            +     '<th style="width:44%">Descripci\u00F3n</th>'
            +     '<th style="width:12%;text-align:center">Lotes</th>'
            +     '<th style="width:30%;text-align:right">Costo x Lote</th>'
            +   '</tr></thead>'
            +   '<tbody>' + rows + '</tbody>'
            +   '<tfoot>'
            +     '<tr class="total-row">'
            +       '<td colspan="2" style="text-align:right">TOTALES:</td>'
            +       '<td style="text-align:center">' + totalUnidades + ' lotes</td>'
            +       '<td style="text-align:right">' + fmt(totalValor) + '</td>'
            +     '</tr>'
            +   '</tfoot>'
            + '</table>'
            + '<div class="obs"><strong>Observaciones:</strong> ' + (data.observaciones || 'Sin observaciones.') + '</div>'
            + '<div class="firmas"><div class="firma"><div class="linea"></div><p>Autorizado / Despachado por</p></div><div class="firma"><div class="linea"></div><p>Recibido por (Destino)</p></div></div>'
            + '<scr' + 'ipt>window.onload=function(){window.print();window.onafterprint=function(){window.close();};};</scr' + 'ipt>'
            + '</body></html>';

        var win = window.open('', '_blank', 'width=900,height=700');
        if (!win) { alert('Permite las ventanas emergentes para imprimir el conduce.'); return; }
        win.document.open();
        win.document.write(html);
        win.document.close();
    };
</script>

@code {
    private SistemaAlmacen.Models.ConfiguracionEmpresa? empresa;
    private List<Producto> productos = new();
    private List<Producto> filteredProductos = new();
    private List<Movimiento> historialSalidas = new();
    private List<ItemSalida> listaSalida = new();
    private Producto? productoSeleccionado;

    private string proximaReferencia = "";
    private string searchQuery = "", destino = "", notasLibres = "", usuarioActual = "";
    private int cantidadADespachar = 1;
    private bool mostrarSugerencias = false, guardando = false, mostrarModal = false;
    private DialogModal DialogRef = default!;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        usuarioActual = authState.User.Identity?.Name ?? "Admin";
        empresa = await ContextConf.ConfiguracionEmpresas.FirstOrDefaultAsync()
                  ?? new SistemaAlmacen.Models.ConfiguracionEmpresa();
    }

    private async Task CargarDatos()
    {
        productos = await ProductoService.ObtenerTodosAsync();
        var todos = await MovimientoService.ObtenerTodosAsync();
        historialSalidas = todos
            .Where(m => m.Tipo == "Salida" && m.Observaciones != null && m.Observaciones.StartsWith("SAL-"))
            .ToList();
    }

    private void AbrirModalNuevo()
    {
        listaSalida.Clear();
        destino = ""; notasLibres = "";
        productoSeleccionado = null; searchQuery = "";
        proximaReferencia = $"SAL-{DateTime.Now:yyyyMMdd-HHmm}";
        mostrarModal = true;
    }

    private void CerrarModal() => mostrarModal = false;

    private void OnSearchProducto(ChangeEventArgs e)
    {
        searchQuery = e.Value?.ToString() ?? "";
        mostrarSugerencias = !string.IsNullOrEmpty(searchQuery);
        filteredProductos = productos
            .Where(p => p.Nombre.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)
                     || p.Codigo.Contains(searchQuery, StringComparison.OrdinalIgnoreCase))
            .Take(8).ToList();
    }

    private void SeleccionarProducto(Producto p)
    {
        productoSeleccionado = p;
        searchQuery = p.Nombre;
        mostrarSugerencias = false;
        cantidadADespachar = 1;
    }

    private void AgregarALista()
    {
        if (productoSeleccionado == null || cantidadADespachar < 1 || cantidadADespachar > productoSeleccionado.Existencias)
            return;

        var existente = listaSalida.FirstOrDefault(x => x.ProductoId == productoSeleccionado.Id);
        if (existente != null)
            existente.Cantidad += cantidadADespachar;
        else
            listaSalida.Add(new ItemSalida
            {
                ProductoId     = productoSeleccionado.Id,
                ProductoNombre = productoSeleccionado.Nombre,
                ProductoCodigo = productoSeleccionado.Codigo,
                Cantidad       = cantidadADespachar
            });

        productoSeleccionado = null;
        searchQuery = "";
        cantidadADespachar = 1;
    }

    private void QuitarDeLista(ItemSalida item) => listaSalida.Remove(item);

    private async Task ImprimirConduce(string destino, string referencia, string notas)
    {
        var items = listaSalida.Select(i => new {
            codigo        = i.ProductoCodigo,
            nombre        = i.ProductoNombre,
            cantidad      = i.Cantidad,
            precioUnitario= i.PrecioUnitario,
            totalItem     = i.Cantidad * i.PrecioUnitario
        }).ToArray();

        var data = new {
            referencia,
            fecha            = DateTime.Now.ToString("dd/MM/yyyy  HH:mm"),
            destino          = destino.ToUpper(),
            usuario          = usuarioActual.ToUpper(),
            observaciones    = notas,
            items,
            empresaNombre    = empresa?.NombreEmpresa    ?? "AlmaTrack",
            empresaSlogan    = empresa?.Slogan           ?? "Sistema de Control de Inventario",
            empresaIniciales = empresa?.Iniciales        ?? "AT",
            empresaRNC       = empresa?.RNC              ?? "",
            empresaTelefono  = empresa?.Telefono         ?? "",
            empresaDireccion = empresa?.Direccion        ?? "",
            empresaLogo      = string.IsNullOrEmpty(empresa?.LogoBase64)
                                 ? null
                                 : $"data:{empresa.LogoMediaType};base64,{empresa.LogoBase64}"
        };

        await JS.InvokeVoidAsync("printConduce", data);
    }

    private async Task ProcesarSalida()
    {
        if (string.IsNullOrEmpty(destino) || !listaSalida.Any()) return;
        guardando = true;
        try
        {
            var todosMovs = await MovimientoService.ObtenerTodosAsync();
            foreach (var item in listaSalida)
            {
                var ultimoPrecio = todosMovs
                    .Where(m => m.ProductoId == item.ProductoId && m.Tipo == "Entrada" && m.PrecioCompra > 0)
                    .OrderByDescending(m => m.Fecha)
                    .Select(m => m.PrecioCompra ?? 0)
                    .FirstOrDefault();
                item.PrecioUnitario = ultimoPrecio;
            }

            var destinoCaptura    = destino;
            var referenciaCaptura = proximaReferencia;
            var notasCaptura      = notasLibres;
            var itemsParaConduce  = listaSalida.Select(i => new ItemSalida
            {
                ProductoId     = i.ProductoId,
                ProductoCodigo = i.ProductoCodigo,
                ProductoNombre = i.ProductoNombre,
                Cantidad       = i.Cantidad,
                PrecioUnitario = i.PrecioUnitario
            }).ToList();

            foreach (var item in listaSalida)
            {
                var ok = await MovimientoService.RegistrarSalidaAsync(
                    productoId:    item.ProductoId,
                    cantidad:      item.Cantidad,
                    destino:       destino,
                    observaciones: proximaReferencia,
                    usuario:       usuarioActual);

                if (!ok)
                {
                    await DialogRef.ShowErrorAsync("Error", $"No se pudo registrar '{item.ProductoNombre}'. Verifique existencias.");
                    return;
                }
            }

            mostrarModal = false;
            await CargarDatos();
            listaSalida = itemsParaConduce;
            await ImprimirConduce(destinoCaptura, referenciaCaptura, notasCaptura);
            await DialogRef.ShowSuccessAsync("Completado", "Despacho registrado correctamente.");
        }
        catch (Exception ex) { await DialogRef.ShowErrorAsync("Error", ex.Message); }
        finally { guardando = false; }
    }

    private async Task Reimprimir(string referencia)
    {
        if (string.IsNullOrEmpty(referencia)) return;
        var grupo = historialSalidas.Where(m => m.Observaciones == referencia).ToList();
        if (!grupo.Any()) return;

        listaSalida = grupo.Select(m => new ItemSalida
        {
            ProductoCodigo = m.Producto?.Codigo ?? "",
            ProductoNombre = m.Producto?.Nombre ?? "",
            Cantidad       = m.Cantidad,
            PrecioUnitario = m.PrecioCompra ?? 0
        }).ToList();

        destino           = grupo.First().Destino ?? "";
        usuarioActual     = grupo.First().UsuarioResponsable ?? usuarioActual;
        proximaReferencia = referencia;
        notasLibres       = "";
        await ImprimirConduce(destino, referencia, "");
    }

    public class ItemSalida
    {
        public int ProductoId { get; set; }
        public string ProductoNombre { get; set; } = "";
        public string ProductoCodigo { get; set; } = "";
        public int Cantidad { get; set; }
        public decimal PrecioUnitario { get; set; } = 0;
    }
}
