@page "/proveedores"
@attribute [Authorize(Roles = "Admin,Gerente,Analista")]
@rendermode InteractiveServer
@using SistemaAlmacen.Models
@using SistemaAlmacen.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@inject ApplicationDbContext Context
@inject IJSRuntime JS

<PageTitle>Proveedores - AlmaTrack</PageTitle>

<div style="width: 100%; padding: 0;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #2196f3;">
        <h1 style="margin: 0; font-size: 2rem; color: #2d3748;">🚚 Gestión de Proveedores</h1>
        <button @onclick="AbrirModalNuevo" style="background: linear-gradient(135deg, #2196f3, #1976d2); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: transform 0.2s;">
            ➕ Nuevo Proveedor
        </button>
    </div>

    @if (cargando)
    {
        <div style="text-align: center; padding: 60px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <p style="font-size: 1.2rem; color: #718096;">⏳ Cargando proveedores...</p>
        </div>
    }
    else if (!proveedores.Any())
    {
        <div style="text-align: center; padding: 80px 20px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <div style="font-size: 5rem; margin-bottom: 20px;">📭</div>
            <h3 style="font-size: 1.5rem; margin-bottom: 10px; color: #2d3748;">No hay proveedores registrados</h3>
            <p style="color: #718096; margin-bottom: 30px;">Comienza agregando tu primer proveedor</p>
            <button @onclick="AbrirModalNuevo" style="background: #2196f3; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                ➕ Agregar Proveedor
            </button>
        </div>
    }
    else
    {
        <input type="text" @bind="busqueda" @bind:event="oninput" placeholder="🔍 Buscar por nombre, RNC o teléfono..."
               style="width: 100%; padding: 12px 20px; margin-bottom: 20px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s;" />

        <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; min-width: 900px;">
                    <thead style="background: linear-gradient(135deg, #2196f3, #1976d2); color: white;">
                        <tr>
                            <th style="padding: 15px; text-align: left; font-weight: 600;">Nombre</th>
                            <th style="padding: 15px; text-align: left; font-weight: 600;">RNC</th>
                            <th style="padding: 15px; text-align: left; font-weight: 600;">Teléfono</th>
                            <th style="padding: 15px; text-align: left; font-weight: 600;">Email</th>
                            <th style="padding: 15px; text-align: left; font-weight: 600;">Dirección</th>
                            <th style="padding: 15px; text-align: left; font-weight: 600;">Estado</th>
                            <th style="padding: 15px; text-align: left; font-weight: 600;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in Filtrados)
                        {
                            <tr style="border-bottom: 1px solid #f0f0f0; transition: background-color 0.2s;">
                                <td style="padding: 15px;"><strong style="color: #2d3748;">@p.Nombre</strong></td>
                                <td style="padding: 15px; color: #2d3748;">@(p.RNC ?? "N/A")</td>
                                <td style="padding: 15px; color: #2d3748;">@(p.Telefono ?? "N/A")</td>
                                <td style="padding: 15px; color: #2d3748;">@(p.Email ?? "N/A")</td>
                                <td style="padding: 15px; color: #718096; font-size: 0.9rem;">@(p.Direccion ?? "Sin dirección")</td>
                                <td style="padding: 15px;">
                                    @if (p.Activo)
                                    {
                                        <span style="padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; background: #4caf50; color: white; display: inline-block;">
                                            ✅ Activo
                                        </span>
                                    }
                                    else
                                    {
                                        <span style="padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; background: #f44336; color: white; display: inline-block;">
                                            ❌ Inactivo
                                        </span>
                                    }
                                </td>
                                <td style="padding: 15px;">
                                    <div style="display: flex; gap: 8px; flex-wrap: nowrap;">
                                        <button @onclick="() => VerDetalle(p)" title="Ver detalles" style="padding: 8px 12px; background: #2196f3; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1rem; transition: transform 0.2s;">
                                            👁️
                                        </button>
                                        <button @onclick="() => Editar(p)" title="Editar" style="padding: 8px 12px; background: #ff9800; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1rem; transition: transform 0.2s;">
                                            ✏️
                                        </button>
                                        <button @onclick="() => Eliminar(p)" title="Eliminar" style="padding: 8px 12px; background: #f44336; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1rem; transition: transform 0.2s;">
                                            🗑️
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div style="padding: 15px; background: white; text-align: right; border-radius: 0 0 12px 12px; border-top: 1px solid #f0f0f0;">
            <p style="color: #2d3748;"><strong>Total:</strong> @Filtrados.Count proveedores</p>
        </div>
    }
</div>

@if (mostrarModal)
{
    <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000;" @onclick="CerrarModal">
        <div style="background: white; border-radius: 15px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto;" @onclick:stopPropagation>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; border-bottom: 2px solid #f0f0f0;">
                <h3 style="margin: 0; font-size: 1.5rem; color: #2d3748;">@(esEdicion ? "✏️ Editar" : "➕ Nuevo") Proveedor</h3>
                <button @onclick="CerrarModal" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #718096; line-height: 1;">×</button>
            </div>

            <div style="padding: 25px;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Nombre *</label>
                    <input type="text" @bind="form.Nombre" style="width: 100%; padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="Nombre del proveedor" />
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">RNC</label>
                        <input type="text" @bind="form.RNC" style="width: 100%; padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="000-0000000-0" />
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Teléfono</label>
                        <input type="text" @bind="form.Telefono" style="width: 100%; padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="(809) 000-0000" />
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Email</label>
                    <input type="email" @bind="form.Email" style="width: 100%; padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem;" placeholder="proveedor@ejemplo.com" />
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2d3748;">Dirección</label>
                    <textarea @bind="form.Direccion" rows="3" style="width: 100%; padding: 10px 15px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; resize: vertical;" placeholder="Dirección completa del proveedor"></textarea>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" @bind="form.Activo" style="width: 20px; height: 20px; cursor: pointer;" />
                        <span style="font-weight: 600; color: #2d3748;">Proveedor activo</span>
                    </label>
                </div>

                @if (!string.IsNullOrEmpty(error))
                {
                    <div style="padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; background: #ffebee; color: #c62828; border: 1px solid #ef5350;">
                        ❌ @error
                    </div>
                }

                <div style="display: flex; justify-content: flex-end; gap: 15px; padding-top: 20px; border-top: 2px solid #f0f0f0;">
                    <button @onclick="CerrarModal" style="background: #6c757d; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Cancelar
                    </button>
                    <button @onclick="Guardar" disabled="@guardando" style="background: #2196f3; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; opacity: @(guardando ? "0.6" : "1");">
                        @(guardando ? "⏳ Guardando..." : "💾 Guardar")
                    </button>
                </div>
            </div>
        </div>
    </div>
}


@if (mostrarDetalle && detalle != null)
{
    <div style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000;" @onclick="CerrarDetalle">
        <div style="background: white; border-radius: 15px; width: 90%; max-width: 600px;" @onclick:stopPropagation>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; border-bottom: 2px solid #f0f0f0;">
                <h3 style="margin: 0; color: #2d3748;">📋 Detalles del Proveedor</h3>
                <button @onclick="CerrarDetalle" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: #718096; line-height: 1;">×</button>
            </div>

            <div style="padding: 25px;">
                <div style="display: grid; gap: 15px;">
                    <div style="display: grid; grid-template-columns: 150px 1fr; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                        <strong style="color: #2196f3;">Nombre:</strong>
                        <span style="color: #2d3748;">@detalle.Nombre</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 150px 1fr; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                        <strong style="color: #2196f3;">RNC:</strong>
                        <span style="color: #2d3748;">@(detalle.RNC ?? "No especificado")</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 150px 1fr; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                        <strong style="color: #2196f3;">Teléfono:</strong>
                        <span style="color: #2d3748;">@(detalle.Telefono ?? "No especificado")</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 150px 1fr; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                        <strong style="color: #2196f3;">Email:</strong>
                        <span style="color: #2d3748;">@(detalle.Email ?? "No especificado")</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 150px 1fr; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                        <strong style="color: #2196f3;">Dirección:</strong>
                        <span style="color: #2d3748;">@(detalle.Direccion ?? "No especificada")</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 150px 1fr; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                        <strong style="color: #2196f3;">Fecha Registro:</strong>
                        <span style="color: #2d3748;">@detalle.FechaRegistro.ToString("dd/MM/yyyy")</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 150px 1fr; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                        <strong style="color: #2196f3;">Estado:</strong>
                        <span style="color: #2d3748;">@(detalle.Activo ? "✅ Activo" : "❌ Inactivo")</span>
                    </div>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 15px; margin-top: 20px; padding-top: 20px; border-top: 2px solid #f0f0f0;">
                    <button @onclick="CerrarDetalle" style="background: #6c757d; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        Cerrar
                    </button>
                    <button @onclick="() => { CerrarDetalle(); Editar(detalle); }" style="background: #2196f3; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        ✏️ Editar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Proveedor> proveedores = new();
    private Proveedor form = new();
    private Proveedor? detalle;
    private string busqueda = "";
    private string error = "";
    private bool cargando = true;
    private bool mostrarModal = false;
    private bool mostrarDetalle = false;
    private bool esEdicion = false;
    private bool guardando = false;

    private List<Proveedor> Filtrados =>
        string.IsNullOrWhiteSpace(busqueda)
            ? proveedores
            : proveedores.Where(p =>
                p.Nombre.Contains(busqueda, StringComparison.OrdinalIgnoreCase) ||
                (p.RNC != null && p.RNC.Contains(busqueda, StringComparison.OrdinalIgnoreCase)) ||
                (p.Telefono != null && p.Telefono.Contains(busqueda, StringComparison.OrdinalIgnoreCase))
            ).ToList();

    protected override async Task OnInitializedAsync()
    {
        await Cargar();
    }

    private async Task Cargar()
    {
        cargando = true;
        proveedores = await Context.Proveedores
            .OrderByDescending(p => p.FechaRegistro)
            .ToListAsync();
        cargando = false;
    }

    private void AbrirModalNuevo()
    {
        form = new Proveedor
        {
            Activo = true,
            FechaRegistro = DateTime.Now
        };
        esEdicion = false;
        error = "";
        mostrarModal = true;
    }

    private void Editar(Proveedor p)
    {
        form = new Proveedor
        {
            Id = p.Id,
            Nombre = p.Nombre,
            RNC = p.RNC,
            Telefono = p.Telefono,
            Email = p.Email,
            Direccion = p.Direccion,
            Activo = p.Activo,
            FechaRegistro = p.FechaRegistro
        };
        esEdicion = true;
        error = "";
        mostrarModal = true;
    }

    private async Task Guardar()
    {
        if (string.IsNullOrWhiteSpace(form.Nombre))
        {
            error = "El nombre es requerido";
            return;
        }

        guardando = true;
        error = "";

        try
        {
            if (esEdicion)
            {
                Context.Proveedores.Update(form);
            }
            else
            {
                form.FechaRegistro = DateTime.Now;
                Context.Proveedores.Add(form);
            }

            await Context.SaveChangesAsync();
            await Cargar();
            CerrarModal();
            await JS.InvokeVoidAsync("alert", esEdicion ? "✅ Proveedor actualizado" : "✅ Proveedor agregado");
        }
        catch (Exception ex)
        {
            error = $"Error: {ex.Message}";
        }
        finally
        {
            guardando = false;
        }
    }

    private async Task Eliminar(Proveedor p)
    {
        bool ok = await JS.InvokeAsync<bool>("confirm", $"¿Eliminar el proveedor '{p.Nombre}'?");
        if (ok)
        {
            Context.Proveedores.Remove(p);
            await Context.SaveChangesAsync();
            await Cargar();
            await JS.InvokeVoidAsync("alert", "✅ Proveedor eliminado");
        }
    }

    private void VerDetalle(Proveedor p)
    {
        detalle = p;
        mostrarDetalle = true;
    }

    private void CerrarModal()
    {
        mostrarModal = false;
        form = new();
        error = "";
    }

    private void CerrarDetalle()
    {
        mostrarDetalle = false;
        detalle = null;
    }
}