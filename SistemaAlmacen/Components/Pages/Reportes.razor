@page "/reportes"
@attribute [Authorize(Roles = "Admin,Gerente,Analista")]
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using SistemaAlmacen.Models
@using SistemaAlmacen.Data
@using Microsoft.EntityFrameworkCore
@using ClosedXML.Excel
@inject ApplicationDbContext Context
@inject IJSRuntime JS
@inject IWebHostEnvironment Environment

<DialogModal @ref="DialogRef" />

<PageTitle>Reportes - AlmaTrack</PageTitle>

<div class="reportes-wrapper">

    <div class="no-print page-header">
        <div class="header-left">
            <h1 class="main-title">Centro de Reportes</h1>
            <p class="sub-title">Auditoría de movimientos, filtros avanzados y exportación</p>
        </div>
        <div class="action-buttons">
            <button @onclick="LanzarImpresion" class="btn-action btn-print">🖨️ Imprimir</button>
            <button @onclick="ExportarExcel" class="btn-action btn-excel">📊 Excel</button>
        </div>
    </div>

    <div class="no-print filters-card">
        <div class="filters-title">Filtros</div>
        <div class="filters-grid">
            <div class="f-group">
                <label>Tipo de Movimiento</label>
                <select @bind="filtroTipoMov">
                    <option value="">Todos</option>
                    <option value="Entrada">Entradas</option>
                    <option value="Salida">Salidas</option>
                </select>
            </div>
            <div class="f-group">
                <label>Categoría</label>
                <select @bind="categoriaId">
                    <option value="0">Todas</option>
                    @foreach (var cat in categorias) { <option value="@cat.Id">@cat.Nombre</option> }
                </select>
            </div>
            <div class="f-group">
                <label>Existencias</label>
                <select @bind="filtroStock">
                    <option value="">Todas</option>
                    <option value="bajo">Existencias bajas (≤3)</option>
                    <option value="vacio">Sin existencias (0)</option>
                </select>
            </div>
            <div class="f-group">
                <label>Proveedor</label>
                <select @bind="proveedorId">
                    <option value="0">Todos</option>
                    @foreach (var prov in proveedores) { <option value="@prov.Id">@prov.Nombre</option> }
                </select>
            </div>
            <div class="f-group">
                <label>Responsable</label>
                <select @bind="usuarioSeleccionado">
                    <option value="">Todos</option>
                    @foreach (var user in usuarios) { <option value="@user">@user</option> }
                </select>
            </div>
            <div class="f-group">
                <label>Producto</label>
                <select @bind="productoId">
                    <option value="0">Todos</option>
                    @foreach (var prod in productos) { <option value="@prod.Id">@prod.Nombre</option> }
                </select>
            </div>
            <div class="f-group">
                <label>Desde</label>
                <input type="date" @bind="fechaInicio" />
            </div>
            <div class="f-group">
                <label>Hasta</label>
                <input type="date" @bind="fechaFin" />
            </div>
            <div class="f-group f-actions">
                <button @onclick="FiltrarTodo" class="btn-search">Aplicar</button>
                <button @onclick="LimpiarFiltros" class="btn-clear">Limpiar</button>
            </div>
        </div>

        <div class="summary-cards">
            <div class="s-card s-card-in">
                <div class="s-label">Total Entradas</div>
                <div class="s-value">RD$ @movimientosFiltrados.Where(m => m.Tipo == "Entrada").Sum(m => (m.PrecioCompra ?? 0) * m.Cantidad).ToString("N2")</div>
                <div class="s-count">@movimientosFiltrados.Count(m => m.Tipo == "Entrada") movimientos</div>
            </div>
            <div class="s-card s-card-out">
                <div class="s-label">Total Salidas (Valor)</div>
                <div class="s-value">RD$ @movimientosFiltrados.Where(m => m.Tipo == "Salida").Sum(m => (m.PrecioCompra ?? 0) * m.Cantidad).ToString("N2")</div>
                <div class="s-count">@movimientosFiltrados.Count(m => m.Tipo == "Salida") movimientos</div>
            </div>
            <div class="s-card s-card-net">
                <div class="s-label">Valor Neto en Almacén</div>
                <div class="s-value">
                    RD$ @((movimientosFiltrados.Where(m => m.Tipo == "Entrada").Sum(m => (m.PrecioCompra ?? 0) * m.Cantidad)
                         - movimientosFiltrados.Where(m => m.Tipo == "Salida").Sum(m => (m.PrecioCompra ?? 0) * m.Cantidad)).ToString("N2"))
                </div>
                <div class="s-count">@movimientosFiltrados.Count() registros totales</div>
            </div>
        </div>
    </div>

    <div class="print-area">
        <div class="print-header">
            <div>
                <div class="brand-print">ALMATRACK</div>
                <div class="brand-sub-print">Sistema de Control de Almacén</div>
            </div>
            <div style="text-align:right">
                <strong>REPORTE DE AUDITORÍA</strong><br />
                <span style="font-size:9pt">Emitido: @DateTime.Now.ToString("dd/MM/yyyy HH:mm")</span>
            </div>
        </div>

        <div class="table-wrap">
            <table class="report-table">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Tipo</th>
                        <th>Producto / Código</th>
                        <th>Categoría</th>
                        <th>Proveedor</th>
                        <th>Destino</th>
                        <th>Cant.</th>
                        <th>Valor Unitario</th>
                        <th>Total Operación</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var m in movimientosFiltrados)
                    {
                        <tr>
                            <td class="col-fecha">@m.Fecha.ToString("dd/MM/yy")</td>
                            <td>
                                <span class="tipo-badge @(m.Tipo == "Entrada" ? "badge-in" : "badge-out")">
                                    @m.Tipo
                                </span>
                            </td>
                            <td>
                                <span class="prod-name">@m.Producto?.Nombre</span>
                                <span class="prod-code">@m.Producto?.Codigo</span>
                            </td>
                            <td>@m.Producto?.Categoria?.Nombre</td>
                            <td class="col-prov">
                                @if (m.Tipo == "Entrada")
                                {
                                    <span class="tag-prov">@(m.Proveedor?.Nombre ?? "—")</span>
                                }
                                else { <span class="tag-na">—</span> }
                            </td>
                            <td class="col-dest">
                                @if (m.Tipo == "Salida")
                                {
                                    <span class="tag-dest">@(m.Destino ?? "—")</span>
                                }
                                else { <span class="tag-na">—</span> }
                            </td>
                            <td class="col-num">@m.Cantidad</td>
                            <td class="col-num">RD$ @((m.PrecioCompra ?? 0).ToString("N2"))</td>
                            <td class="col-num @(m.Tipo == "Salida" ? "val-out" : "val-in")">
                                @if (m.Tipo == "Salida") { <span>− </span> }
                                RD$ @(((m.PrecioCompra ?? 0) * m.Cantidad).ToString("N2"))
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr class="foot-entradas">
                        <td colspan="8" style="text-align:right">TOTAL ENTRADAS:</td>
                        <td class="val-in">
                            RD$ @movimientosFiltrados.Where(m => m.Tipo == "Entrada").Sum(m => (m.PrecioCompra ?? 0) * m.Cantidad).ToString("N2")
                        </td>
                    </tr>
                    <tr class="foot-salidas">
                        <td colspan="8" style="text-align:right">TOTAL SALIDAS:</td>
                        <td class="val-out">
                            − RD$ @movimientosFiltrados.Where(m => m.Tipo == "Salida").Sum(m => (m.PrecioCompra ?? 0) * m.Cantidad).ToString("N2")
                        </td>
                    </tr>
                    <tr class="foot-neto">
                        <td colspan="8" style="text-align:right">VALOR NETO EN ALMACÉN:</td>
                        <td class="val-neto">
                            RD$ @((movimientosFiltrados.Where(m => m.Tipo == "Entrada").Sum(m => (m.PrecioCompra ?? 0) * m.Cantidad)
                                 - movimientosFiltrados.Where(m => m.Tipo == "Salida").Sum(m => (m.PrecioCompra ?? 0) * m.Cantidad)).ToString("N2"))
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="print-footer">
            <div class="sig-box">
                <div class="sig-line"></div>
                <p>Firma Auditor / Almacén</p>
            </div>
            <div class="sig-box">
                <div class="sig-line"></div>
                <p>Sello de Oficina</p>
            </div>
        </div>
    </div>
</div>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Sora:wght@300;400;500;600;700&display=swap');

    :root {
        --blue: #1414b8;
        --blue-light: #eef2ff;
        --blue-mid: #4f52d3;
        --green: #059669;
        --green-light: #ecfdf5;
        --red: #dc2626;
        --red-light: #fef2f2;
        --text: black;
        --muted: #64748b;
        --border: #e2e8f0;
        --bg: #f8fafc;
        --white: #fff;
        --mono: 'IBM Plex Mono', monospace;
        --sans: 'Sora', sans-serif;
        --radius: 10px;
        --shadow: 0 4px 24px rgba(20,20,184,0.07);
    }

    .reportes-wrapper { padding: 28px; font-family: var(--sans); }

    .reportes-wrapper .page-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 22px; padding-bottom: 18px; border-bottom: 2px solid var(--border);
    }
    .reportes-wrapper .main-title { font-size: 1.55rem; font-weight: 700; color: #1e293b !important; margin: 0; }
    .reportes-wrapper .sub-title  { color: #64748b !important; font-size: 0.85rem; margin: 4px 0 0; }

    .reportes-wrapper .action-buttons { display: flex; gap: 10px; }
    .reportes-wrapper .btn-action {
        padding: 10px 20px; border: none; border-radius: var(--radius);
        font-weight: 600; font-size: 0.875rem; cursor: pointer;
        font-family: var(--sans); transition: opacity 0.15s, transform 0.1s;
    }
    .reportes-wrapper .btn-action:hover { opacity: 0.88; transform: translateY(-1px); }
    .reportes-wrapper .btn-print { background: var(--blue); color: white !important; }
    .reportes-wrapper .btn-excel { background: #107c41; color: white !important; }

    .reportes-wrapper .filters-card {
        background: #fff; border: 1px solid var(--border);
        border-radius: 14px; padding: 22px 24px; margin-bottom: 24px;
        box-shadow: var(--shadow);
    }
    .reportes-wrapper .filters-title {
        font-size: 0.75rem; font-weight: 700; text-transform: uppercase;
        letter-spacing: 0.08em; color: #64748b !important; margin-bottom: 16px;
    }
    .reportes-wrapper .filters-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 14px;
    }
    .reportes-wrapper .f-group label {
        display: block; font-size: 0.75rem; font-weight: 600;
        color: #64748b !important; text-transform: uppercase;
        letter-spacing: 0.05em; margin-bottom: 6px;
    }
    .reportes-wrapper .f-group select,
    .reportes-wrapper .f-group input {
        width: 100%; padding: 9px 12px;
        border: 1.5px solid var(--border); border-radius: 8px;
        font-size: 0.875rem; font-family: var(--sans);
        color: #1e293b !important; background: #f8fafc !important;
        box-sizing: border-box; transition: border-color 0.2s;
    }
    .reportes-wrapper .f-group select:focus,
    .reportes-wrapper .f-group input:focus {
        outline: none; border-color: var(--blue);
        box-shadow: 0 0 0 3px rgba(20,20,184,0.08);
    }
    .reportes-wrapper .f-actions { display: flex; align-items: flex-end; gap: 8px; }
    .reportes-wrapper .btn-search {
        flex: 1; padding: 9px; background: var(--blue); color: white !important;
        border: none; border-radius: 8px; font-weight: 600;
        cursor: pointer; font-family: var(--sans); font-size: 0.85rem;
    }
    .reportes-wrapper .btn-clear {
        flex: 1; padding: 9px; background: #f8fafc; color: #64748b !important;
        border: 1.5px solid var(--border); border-radius: 8px;
        font-weight: 600; cursor: pointer; font-family: var(--sans); font-size: 0.85rem;
    }

    .reportes-wrapper .summary-cards {
        display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-top: 20px;
    }
    .reportes-wrapper .s-card { padding: 16px 18px; border-radius: var(--radius); border-left: 4px solid transparent; }
    .reportes-wrapper .s-card-in  { background: #ecfdf5; border-color: #059669; }
    .reportes-wrapper .s-card-out { background: #fef2f2; border-color: #dc2626; }
    .reportes-wrapper .s-card-net { background: #eef2ff; border-color: #1414b8; }
    .reportes-wrapper .s-label { font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: #64748b !important; margin-bottom: 6px; }
    .reportes-wrapper .s-value { font-size: 1.2rem; font-weight: 700; color: #1e293b !important; font-family: var(--mono); }
    .reportes-wrapper .s-count { font-size: 0.75rem; color: #64748b !important; margin-top: 4px; }

    .table-wrap {
        background: var(--white); border-radius: 14px;
        border: 1px solid var(--border); overflow-x: auto; box-shadow: var(--shadow);
    }
    .report-table { width: 100%; min-width: 1000px; border-collapse: collapse; font-family: var(--sans); }
    .report-table thead tr { background: var(--bg); border-bottom: 2px solid var(--border); }
    .reportes-wrapper .report-table th {
        padding: 13px 14px; text-align: left;
        font-size: 0.72rem; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.06em; color: #64748b !important;
    }
    .report-table td {
        padding: 11px 14px; border-bottom: 1px solid var(--border);
        font-size: 0.86rem; color: var(--text); vertical-align: middle;
    }
    .report-table tbody tr:hover { background: #fafbff; }
    .report-table tbody tr:last-child td { border-bottom: none; }

    .col-fecha { font-family: var(--mono); font-size: 0.8rem; color: var(--muted); }
    .col-num { font-family: var(--mono); text-align: right; }

    .tipo-badge {
        display: inline-block; padding: 3px 10px; border-radius: 20px;
        font-size: 0.75rem; font-weight: 700;
    }
    .badge-in  { background: var(--green-light); color: var(--green); }
    .badge-out { background: var(--red-light);   color: var(--red); }

    .prod-name { display: block; font-weight: 600; font-size: 0.875rem; }
    .prod-code { display: block; font-family: var(--mono); font-size: 0.75rem; color: var(--muted); }

    .col-prov, .col-dest { font-size: 0.82rem; }
    .tag-prov { color: var(--green); font-weight: 500; }
    .tag-dest { color: var(--blue);  font-weight: 500; }
    .tag-na   { color: var(--border); }

    .val-in  { color: var(--green); font-weight: 600; }
    .val-out { color: var(--red);   font-weight: 600; }
    .val-neto { color: var(--blue); font-weight: 700; font-size: 1rem; font-family: var(--mono); }

    .foot-entradas td, .foot-salidas td, .foot-neto td {
        padding: 10px 14px; font-size: 0.875rem; font-weight: 600;
    }
    .foot-entradas td { border-top: 1px solid var(--border); background: var(--green-light); }
    .foot-salidas td  { background: var(--red-light); }
    .foot-neto td     { background: var(--blue-light); font-size: 0.95rem; border-top: 2px solid var(--blue); }

    /* Solo visible al imprimir */
    .print-header, .print-footer { display: none; }

  
    @@media print {

        /* Ocultar navegación y filtros */
        header, nav, aside, .sidebar,
        .no-print { display: none !important; }

        /* Quitar overflow de TODOS los ancestros posibles */
        html,
        body,
        .reportes-wrapper,
        .print-area,
        .table-wrap,
        [class*="layout"],
        [class*="content"],
        [class*="main"],
        [class*="page"],
        [class*="wrapper"],
        [class*="container"] {
            overflow: visible !important;
            overflow-x: visible !important;
            overflow-y: visible !important;
            height: auto !important;
            max-height: none !important;
            max-width: none !important;
            width: auto !important;
        }

        html, body {
            background: white !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .reportes-wrapper { padding: 0 !important; }

        /* Tabla ocupa todo el ancho del papel */
        .table-wrap {
            box-shadow: none !important;
            border: none !important;
            border-radius: 0 !important;
        }

        .report-table {
            min-width: 0 !important;
            width: 100% !important;
            table-layout: auto !important;
            font-size: 7.5pt !important;
        }

        .report-table th, .report-table td {
            padding: 5px 6px !important;
            word-break: break-word !important;
            overflow-wrap: break-word !important;
        }

        .print-area { padding: 1cm !important; }

        .print-header {
            display: flex !important; justify-content: space-between;
            border-bottom: 2px solid #1414b8; padding-bottom: 12px; margin-bottom: 18px;
        }
        .brand-print { font-size: 20pt; font-weight: 900; color: #1414b8; }
        .brand-sub-print { font-size: 8pt; color: #555; text-transform: uppercase; letter-spacing: .08em; }

        .report-table th {
            background: #1414b8 !important; color: white !important;
            border: 1px solid #000 !important; padding: 7px 9px !important;
            font-size: 7.5pt !important; print-color-adjust: exact;
            -webkit-print-color-adjust: exact;
        }
        .report-table td {
            border: 1px solid #ccc !important; padding: 7px 9px !important;
            font-size: 9pt !important; color: #000 !important;
        }
        .foot-entradas td, .foot-salidas td, .foot-neto td {
            border: 1px solid #000 !important; font-size: 9pt !important;
        }
        .tipo-badge { border: 1px solid #000 !important; }
        .val-out, .val-in, .val-neto { color: #000 !important; }

        .print-footer {
            display: flex !important; justify-content: space-around; margin-top: 70px;
        }
        .sig-box { width: 35%; text-align: center; }
        .sig-line { border-top: 1.5px solid #000; margin-bottom: 7px; }
        .sig-box p { font-size: 8pt; font-weight: 700; text-transform: uppercase; }

        @@page { size: landscape; margin: 0.8cm; }
    }
</style>

@code {
    private List<Movimiento> movimientos = new();
    private List<Movimiento> movimientosFiltrados = new();
    private List<Categoria> categorias = new();
    private List<Proveedor> proveedores = new();
    private List<Producto> productos = new();
    private List<string> usuarios = new();

    private string filtroTipoMov = "";
    private int categoriaId = 0;
    private int proveedorId = 0;
    private int productoId = 0;
    private string filtroStock = "";
    private string usuarioSeleccionado = "";
    private DateTime? fechaInicio = DateTime.Now.AddMonths(-1);
    private DateTime? fechaFin = DateTime.Now;

    private DialogModal DialogRef = default!;

    protected override async Task OnInitializedAsync()
    {
        movimientos = await Context.Movimientos
            .Include(m => m.Producto).ThenInclude(p => p!.Categoria)
            .Include(m => m.Proveedor)
            .OrderByDescending(m => m.Fecha)
            .ToListAsync();

        categorias  = await Context.Categorias.ToListAsync();
        proveedores = await Context.Proveedores.ToListAsync();
        productos   = await Context.Productos.OrderBy(p => p.Nombre).ToListAsync();
        usuarios    = movimientos
            .Select(m => m.UsuarioResponsable)
            .Where(u => u != null)
            .Distinct()
            .ToList()!;

        movimientosFiltrados = movimientos;
    }

    private void FiltrarTodo()
    {
        var q = movimientos.AsQueryable();

        if (!string.IsNullOrEmpty(filtroTipoMov))
            q = q.Where(m => m.Tipo == filtroTipoMov);

        if (categoriaId > 0)
            q = q.Where(m => m.Producto != null && m.Producto.CategoriaId == categoriaId);

        if (proveedorId > 0)
            q = q.Where(m => m.ProveedorId == proveedorId);

        if (!string.IsNullOrEmpty(usuarioSeleccionado))
            q = q.Where(m => m.UsuarioResponsable == usuarioSeleccionado);

        if (productoId > 0)
            q = q.Where(m => m.ProductoId == productoId);

        if (filtroStock == "bajo")
            q = q.Where(m => m.Producto != null && m.Producto.Existencias <= 3 && m.Producto.Existencias > 0);
        if (filtroStock == "vacio")
            q = q.Where(m => m.Producto != null && m.Producto.Existencias == 0);

        if (fechaInicio.HasValue)
            q = q.Where(m => m.Fecha.Date >= fechaInicio.Value.Date);
        if (fechaFin.HasValue)
            q = q.Where(m => m.Fecha.Date <= fechaFin.Value.Date);

        movimientosFiltrados = q.ToList();
    }

    private void LimpiarFiltros()
    {
        filtroTipoMov = ""; categoriaId = 0; proveedorId = 0;
        productoId = 0; filtroStock = ""; usuarioSeleccionado = "";
        fechaInicio = DateTime.Now.AddMonths(-1);
        fechaFin = DateTime.Now;
        movimientosFiltrados = movimientos;
    }

    private async Task LanzarImpresion() =>
        await JS.InvokeVoidAsync("window.print");

    private async Task ExportarExcel()
    {
        try
        {
            using var workbook = new XLWorkbook();
            var ws = workbook.Worksheets.Add("Reporte_AlmaTrack");

            string[] headers = { "Fecha", "Tipo", "Código", "Producto", "Categoría",
                                  "Proveedor", "Destino", "Cant.", "Precio Unitario",
                                  "Total Operación", "Responsable" };
            for (int i = 0; i < headers.Length; i++)
                ws.Cell(1, i + 1).Value = headers[i];

            var headerRange = ws.Range(1, 1, 1, headers.Length);
            headerRange.Style.Font.Bold = true;
            headerRange.Style.Fill.BackgroundColor = XLColor.FromHtml("#1414b8");
            headerRange.Style.Font.FontColor = XLColor.White;

            int row = 2;
            foreach (var m in movimientosFiltrados)
            {
                decimal signo = m.Tipo == "Salida" ? -1 : 1;
                ws.Cell(row, 1).Value  = m.Fecha;
                ws.Cell(row, 2).Value  = m.Tipo;
                ws.Cell(row, 3).Value  = m.Producto?.Codigo;
                ws.Cell(row, 4).Value  = m.Producto?.Nombre;
                ws.Cell(row, 5).Value  = m.Producto?.Categoria?.Nombre;
                ws.Cell(row, 6).Value  = m.Tipo == "Entrada" ? (m.Proveedor?.Nombre ?? "—") : "—";
                ws.Cell(row, 7).Value  = m.Tipo == "Salida"  ? (m.Destino ?? "—") : "—";
                ws.Cell(row, 8).Value  = m.Cantidad;
                ws.Cell(row, 9).Value  = m.PrecioCompra ?? 0;
                ws.Cell(row, 10).Value = signo * (m.PrecioCompra ?? 0) * m.Cantidad;
                ws.Cell(row, 11).Value = m.UsuarioResponsable;

                if (m.Tipo == "Salida")
                    ws.Range(row, 1, row, headers.Length).Style.Fill.BackgroundColor = XLColor.FromHtml("#fff5f5");
                else
                    ws.Range(row, 1, row, headers.Length).Style.Fill.BackgroundColor = XLColor.FromHtml("#f0fdf4");

                row++;
            }

            ws.Cell(row, 9).Value = "TOTAL NETO:";
            ws.Cell(row, 9).Style.Font.Bold = true;
            ws.Cell(row, 10).Value =
                movimientosFiltrados.Where(m => m.Tipo == "Entrada").Sum(m => (m.PrecioCompra ?? 0) * m.Cantidad)
                - movimientosFiltrados.Where(m => m.Tipo == "Salida").Sum(m => (m.PrecioCompra ?? 0) * m.Cantidad);
            ws.Cell(row, 10).Style.Font.Bold = true;
            ws.Cell(row, 10).Style.Font.FontColor = XLColor.FromHtml("#1414b8");

            ws.Columns().AdjustToContents();

            using var stream = new MemoryStream();
            workbook.SaveAs(stream);
            var bytes = stream.ToArray();
            var fileName = $"Reporte_AlmaTrack_{DateTime.Now:yyyyMMdd_HHmm}.xlsx";
            await JS.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(bytes));
        }
        catch (Exception ex)
        {
            await DialogRef.ShowErrorAsync("Error", "No se pudo generar el Excel: " + ex.Message);
        }
    }
}
