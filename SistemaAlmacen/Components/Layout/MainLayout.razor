@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation

<AuthorizeView>
    <Authorized>
        <div class="page-layout">
            <!-- Barra superior -->
            <header class="top-bar">
                <div class="top-bar-content">
                    <div class="logo-section">
                        <span class="logo-icon">
                            <svg width="45" height="45" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <linearGradient id="gradAlma" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <circle cx="50" cy="50" r="45" fill="url(#gradAlma)" stroke="#fff" stroke-width="4" />
                                <path d="M 50 25 L 65 65 L 58 65 L 55 55 L 45 55 L 42 65 L 35 65 Z" fill="white" stroke="white" stroke-width="2" />
                                <path d="M 47 50 L 53 50 L 50 40 Z" fill="#667eea" />
                                <line x1="30" y1="75" x2="70" y2="75" stroke="white" stroke-width="3" stroke-linecap="round" />
                                <circle cx="30" cy="75" r="4" fill="#4caf50" />
                                <circle cx="50" cy="75" r="4" fill="#ffc107" />
                                <circle cx="70" cy="75" r="4" fill="#f44336" />
                            </svg>
                        </span>
                        <h1>AlmaTrack</h1>
                    </div>

                    <div class="user-section">
                        <div class="user-info">
                            <div class="user-avatar">
                                @GetInitials(context.User.Identity?.Name ?? "U")
                            </div>
                            <div class="user-details">
                                <span class="user-name">@context.User.Identity?.Name</span>
                                <span class="user-role">@GetUserRole(context)</span>
                            </div>
                        </div>
                        <a href="/Account/Logout" class="btn-logout" title="Cerrar sesión">
                            🚪
                        </a>
                    </div>
                </div>
            </header>

            <!-- Menú lateral -->
            <nav class="sidebar">
                <!-- Dashboard - Todos los roles -->
                <div class="menu-section" style="animation-delay: 0.1s;">
                    <p class="menu-title">⚡ PRINCIPAL</p>
                    <a href="/" class="menu-item @GetActiveClass("/")">
                        <span class="icon">
                            <svg width="22" height="22" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                <rect x="5" y="5" width="40" height="40" fill="currentColor" rx="5" />
                                <rect x="55" y="5" width="40" height="25" fill="currentColor" rx="5" />
                                <rect x="5" y="55" width="40" height="40" fill="currentColor" rx="5" />
                                <rect x="55" y="40" width="40" height="55" fill="currentColor" rx="5" />
                                <circle cx="25" cy="25" r="8" fill="white" opacity="0.3" />
                                <circle cx="75" cy="17" r="5" fill="white" opacity="0.3" />
                            </svg>
                        </span>
                        <span>Dashboard</span>
                    </a>
                </div>

                <!-- Inventario - Admin, Gerente, Empleado, Almacenista -->
                @if (context.User.IsInRole("Admin") || context.User.IsInRole("Gerente") || context.User.IsInRole("Empleado") || context.User.IsInRole("Almacenista"))
                {
                    <div class="menu-section" style="animation-delay: 0.2s;">
                        <p class="menu-title">📦 INVENTARIO</p>
                        <a href="/productos" class="menu-item @GetActiveClass("/productos")">
                            <span class="icon">📦</span>
                            <span>Productos</span>
                        </a>
                        @if (context.User.IsInRole("Admin") || context.User.IsInRole("Gerente") || context.User.IsInRole("Empleado"))
                        {
                            <a href="/categorias" class="menu-item @GetActiveClass("/categorias")">
                                <span class="icon">🏷️</span>
                                <span>Categorías</span>
                            </a>
                            <a href="/proveedores" class="menu-item @GetActiveClass("/proveedores")">
                                <span class="icon">🚚</span>
                                <span>Proveedores</span>
                            </a>
                        }
                    </div>
                }

                <!-- Movimientos - Admin, Gerente, Almacenista -->
                @if (context.User.IsInRole("Admin") || context.User.IsInRole("Gerente") || context.User.IsInRole("Almacenista"))
                {
                    <div class="menu-section" style="animation-delay: 0.3s;">
                        <p class="menu-title">📊 MOVIMIENTOS</p>
                        <a href="/movimientos" class="menu-item @GetActiveClass("/movimientos")">
                            <span class="icon">📊</span>
                            <span>Movimientos</span>
                        </a>
                    </div>
                }

                <!-- Reportes - Admin, Gerente, Analista -->
                @if (context.User.IsInRole("Admin") || context.User.IsInRole("Gerente") || context.User.IsInRole("Analista"))
                {
                    <div class="menu-section" style="animation-delay: 0.4s;">
                        <p class="menu-title">📈 ANÁLISIS</p>
                        <a href="/reportes" class="menu-item @GetActiveClass("/reportes")">
                            <span class="icon">📈</span>
                            <span>Reportes</span>
                        </a>
                    </div>
                }

                <!-- Administración - Solo Admin -->
                @if (context.User.IsInRole("Admin"))
                {
                    <div class="menu-section" style="animation-delay: 0.5s;">
                        <p class="menu-title">⚙️ ADMINISTRACIÓN</p>
                        <a href="/usuarios" class="menu-item @GetActiveClass("/usuarios")">
                            <span class="icon">👥</span>
                            <span>Usuarios</span>
                        </a>
                    </div>
                }
            </nav>

            <!-- Contenido principal -->
            <main class="main-content">
                @Body
            </main>
        </div>
    </Authorized>
    <NotAuthorized>
        @Body
    </NotAuthorized>
</AuthorizeView>

@code {
    private string GetActiveClass(string path)
    {
        var currentPath = new Uri(Navigation.Uri).AbsolutePath;
        return currentPath == path ? "active" : "";
    }

    private string GetInitials(string nombre)
    {
        if (string.IsNullOrWhiteSpace(nombre)) return "U";

        var parts = nombre.Split('@')[0].Split('.');
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        }
        return nombre.Substring(0, Math.Min(2, nombre.Length)).ToUpper();
    }

    private string GetUserRole(AuthenticationState authState)
    {
        if (authState.User.IsInRole("Admin"))
            return "👑 Administrador";
        if (authState.User.IsInRole("Gerente"))
            return "👔 Gerente";
        if (authState.User.IsInRole("Analista"))
            return "📊 Analista";
        if (authState.User.IsInRole("Almacenista"))
            return "📦 Almacenista";
        if (authState.User.IsInRole("Empleado"))
            return "👤 Empleado";

        return "Usuario";
    }
}